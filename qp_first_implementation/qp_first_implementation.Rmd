---
title: "First Implementation of QuickPay (2009-2012)"
date: " `r format(Sys.time(), '%b %d, %Y')`"
output: 
  pdf_document :
    keep_tex: true
    number_sections: true
header-includes:
 \usepackage{booktabs,longtable,dcolumn}
 \usepackage{multirow,array}
 \usepackage{wrapfig,float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r packages,warning=FALSE,message=FALSE,include=FALSE}
library(tidyverse)
library(dplyr)
library(pryr)
library(lfe) # linear fixed effects 
library(DescTools) 
library(zoo) # for year quarter
library(stargazer)
library(broom)
library(data.table)
library(scales)
``` 
```{r read_data, include=FALSE}
# read quarterly resampled data
df=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/resampled_qp_data/quickpay_resampled_fy10_to_fy12.csv')

# specify date columns
date_cols=c("action_date_year_quarter","last_reported_start_date","last_reported_end_date")
df[,(date_cols):= lapply(.SD, as.Date), .SDcols = date_cols]

# restrict to quarter ending June 30, 2012
df=subset(df,as.Date(action_date_year_quarter)<max(as.Date(df$action_date_year_quarter)))
# data is truncated at July 1, 2012 -- 
# so quarter ending Sept 30, 2012 will only have values as of July 1, 2012

df_first_reported=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/qp_data_first_reported.csv')
# contains time-invariant contract characteristics -- info when contract first appeared in the data
```
```{r assign_variables_1, include=FALSE}
# Assign variables: Delay, Winsorized Delay, Post_t, Treat_i ####

# sort by contract id and date 
df=df[order(contract_award_unique_key,
            action_date_year_quarter)]

# determine quarter-to-quarter delay
df[,delay:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1), 
                  last_reported_end_date-lag(last_reported_end_date,1),NaN)]

# winsorize quarter-to-quarter delay
df[,winsorized_delay:=Winsorize(delay,na.rm=TRUE)]

#Post_t: A dummy that period t is post-treatment
df[,post_t:=ifelse(action_date_year_quarter>as.Date("2011-04-27"),1,0)]
# quickpay implemented on 27 April 2011. So all quarters starting 30 June 2011 will be in post-period

#Treat_i: A dummy that contract i is in the treatment group
df[,treat_i:=ifelse(business_type=="S",1,0)]
# quickpay was implemented for small business contracts
```
```{r assign_variables_2, include=FALSE}
# Assign variables: ContractFinancing_i, Competition_i, PerformanceBased_i, Financial_Aid_i ####
df_first_reported[,contract_financing_i:=ifelse(!is.null(contract_financing_code)&
                                       !contract_financing_code%in%c("Z", ""),1,0)]
#### 
df_first_reported[,competitively_awarded_i:=ifelse(!is.null(extent_competed_code)&
                                          !extent_competed_code%in%c("","G","B", "C"),1,0)]
#### 
df_first_reported[,performance_based_contract_i:=ifelse(performance_based_service_acquisition_code=='Y',1,0)]
#### 
df_first_reported[,receives_financial_aid_i:=ifelse(receives_grants=='t'|
                                           c8a_program_participant=='t',1,0)]
#### 
df_first_reported[,receives_contracts_and_financial_aid_i:=ifelse(receives_contracts_and_grants=='t'|
                                                         receives_grants=='t'|
                                                         c8a_program_participant=='t',1,0)]

df_first_reported[,winsorized_initial_duration_in_days_i:=Winsorize(as.numeric(
                               as.Date(period_of_performance_current_end_date)-
                               as.Date(period_of_performance_start_date)),na.rm=T)]
df_first_reported[,winsorized_initial_budget_i:=Winsorize(base_and_all_options_value,na.rm=T)]

select_cols=c("contract_award_unique_key",
              "number_of_offers_received",
              "contract_financing_i",
              "competitively_awarded_i",
              "performance_based_contract_i",
              "receives_financial_aid_i",
              "receives_contracts_and_financial_aid_i",
              "winsorized_initial_duration_in_days_i",
              "winsorized_initial_budget_i")

df_first_reported_cols=df_first_reported[,..select_cols]
# not necessary but speed efficient to set keys
setkey(df_first_reported_cols,contract_award_unique_key)
setkey(df,contract_award_unique_key)
```
```{r combine_dfs, include=FALSE}
# Combine all variables into dataframe needed for regression 
reg_df=merge(df,
             df_first_reported_cols,
             all.x = TRUE, # keep values in df, add columns of df_first_reported_cols
             by=c("contract_award_unique_key"))
```

# Delays over Time

```{r plot, echo=FALSE, results='asis'}
mean_delay=df[!is.na(winsorized_delay) & action_date_year_quarter<as.Date('2012-06-30'), 
              mean(winsorized_delay),  
              by = c('action_date_year_quarter','business_type')]
mean_delay[,year_quarter:=format(action_date_year_quarter,"%Y-%b")]
mean_delay=mean_delay[order(action_date_year_quarter,business_type)]

ggplot(mean_delay, aes(x=year_quarter,
               y=V1, 
               group = business_type, 
               shape=business_type, 
               linetype=business_type))+
    geom_line() +    
    scale_x_discrete(limits=mean_delay$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average delay per quarter (in days)")+  
    annotate("text", label = "QuickPay\n implemented", x = 8, y = 50,color="dimgrey")+
    geom_vline(xintercept = 10.2, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    scale_linetype_discrete(name="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))
```

# Notation 

* Project $i$, Year-Quarter $t$
* $X_i$ denotes project level controls: initial duration, initial budget, number of offers received
* $\mu_t,\theta_{firm},\lambda_{task}$: Year-Quarter, Firm, and Product/Service code Fixed effects
* All continuous variables are winsorized at the 5\% level
$$ Treat_i = \begin{cases} 1, \text{ if project } i \text{ is a small business}\\
0, \text{ otherwise} \end{cases}$$
$$ Post_t = \begin{cases} 1, \text{ if year-quarter } t > \text{ April 27, 2011}\\
0, \text{ otherwise} \end{cases}$$

# Parallel Trends Test

Let $Time$ denote $q$-th quarter since the beginning of time horizon. For $Post_t =0$, we run the following regression:
$$ Delay_{it} = \alpha+\beta_0 Treat_i + \beta_1 (Treat_i \times Time) + \beta_2 X_i + \mu_t + \theta_{firm} + \lambda_{task} +\epsilon_{it}$$
The coefficient of interest is $\beta_1$. If this is significant, we would find evidence of a linear time trend before quickpay implementation -- violating the parallel trends assumption.
```{r parallel_trends_test, echo=FALSE, results='asis'}
df_qn<-unique(reg_df,by='action_date_year_quarter')[,"action_date_year_quarter"]
df_qn=df_qn[order(action_date_year_quarter)][,quarter_number:=seq.int(nrow(df_qn))]
reg_df=merge(reg_df,df_qn,by='action_date_year_quarter')
cluster_var = "contract_award_unique_key"

# Estimating linear time trend before quickpay was implemented
fixed_vars =  c("action_date_year_quarter",
                "recipient_duns",
                "product_or_service_code")

control_vars=c("winsorized_initial_duration_in_days_i",
               "winsorized_initial_budget_i",
               "number_of_offers_received")

pt_formula=formula(paste("winsorized_delay~treat_i+
                         quarter_number:treat_i+",
                         paste(control_vars,collapse="+"),
                         "|", paste(fixed_vars, collapse= "+"),
                         "| 0 |", cluster_var))

parallel_trend<-felm(pt_formula,
                     data=subset(reg_df,post_t==0), 
                     exactDOF = TRUE, 
                     cmethod = "reghdfe")

stargazer(parallel_trend,
          title = "Linear Time Trend Before QuickPay",
          dep.var.labels   = "$Delay_{it}$ (in days)",
          header=FALSE,
          object.names=FALSE, 
          model.numbers=FALSE,
          font.size = "small",
          digits=2,
          digits.extra=2,
          omit.stat=c("f", "ser"),
          add.lines = list(c("Fixed effects","Firm, Task, and Year-Quarter"),
                           c("Controls","Budget, Duration, Bids")), 
          covariate.labels = c("$Treat_i$", "$Treat_i \\times Time$"),
          omit = control_vars,
          table.placement = "H",
          notes=c("Each observation is a project-quarter.","SEs are robust and clustered at the project level.","Observations are for quarters before quickpay."))
```

# Baseline Regressions

$$ Delay_{it} = \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) + \epsilon_{it}$$ 

$$ \begin{aligned} Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t)\\
&+&  X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r baseline_regressions, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          title = "Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$","$Post_t$","$Treat_i \\times Post_t$","Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          digits=2,
          digits.extra=2,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Contract Financing

$$ CF_i = \begin{cases} 1, \text{ if project } i \text{ receives contract financing}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) \\
&+&\beta_3 CF_i + \beta_4 (CF_i \times Post_t) + \beta_5 (Treat_i \times Post_t \times CF_i) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r contract_financing, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    contract_financing_i+post_t:contract_financing_i+
                    post_t:treat_i:contract_financing_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'contract_financing_i',
              'post_t:contract_financing_i',
              'treat_i:post_t:contract_financing_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Contract Financing: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CF_i$",
                               "$Post_t \\times CF_i$",
                               "$Post_t \\times CF_i \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times $  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Receives Financial Aid

$$ FinancialAid = \begin{cases} 1, \text{ if firm receives grants or is a c8A participant}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) +\beta_3 FinancialAid \\
&+& \beta_4 (FinancialAid \times Post_t) + \beta_5 (Treat_i \times Post_t \times FinancialAid) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r financial_aid, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    receives_financial_aid_i+post_t:receives_financial_aid_i+
                    post_t:treat_i:receives_financial_aid_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'receives_financial_aid_i',
              'post_t:receives_financial_aid_i',
              'treat_i:post_t:receives_financial_aid_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Grants or C8A Participant: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$FinancialAid$",
                               "$Post_t \\times FinancialAid$",
                               "$Post_t \\times FinancialAid \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Receives Contracts and Financial Aid

$$ CFA = \begin{cases} 1, \text{ if firm receives "contracts and grants"}\\ 
                       \text{or grants or is a c8A participant}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) +\beta_3 CFA \\
&+& \beta_4 (CFA \times Post_t) + \beta_5 (Treat_i \times Post_t \times CFA) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r contracts_and_financial_aid, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    receives_contracts_and_financial_aid_i+
                    post_t:receives_contracts_and_financial_aid_i+
                    post_t:treat_i:receives_contracts_and_financial_aid_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'receives_contracts_and_financial_aid_i',
              'post_t:receives_contracts_and_financial_aid_i',
              'treat_i:post_t:receives_contracts_and_financial_aid_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Contracts, Grants, or C8A Participant: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CFA$",
                               "$Post_t \\times CFA$",
                               "$Post_t \\times CFA \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Firm's rank order

* Consider a project $i$ of firm $f$ in quarter $t$.
* Let $\Pi_{f,2010}$ denote all projects of firm $f$ in Fiscal Year 2010. 
* Consider $\rho_f = \sum_{i \in \Pi_{f,2010}} (Treat_i \times FAO_{if})/Sales_{f,\text{2010}}$ as the fraction of revenue a firm earns from small government projects.
* Let $\Theta_f = rank(\rho_f)/N$ where $rank(\rho_f)$ is the rank statistic of $\rho_{f}$ and $N = \text{number of firms}.$ For example, $rank(\rho_f)=1$ if $\rho_f=\min(\rho_1,\rho_2,\ldots,\rho_N)$.
* Put simply, $\Theta_f$ is a firm's rank order based on the fraction of revenue it earned from small government projects in FY 2010.

```{r fao, include=FALSE}
# read raw data
df_raw=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/qp_data_fy10_to_fy18.csv')

# restrict to quarters on/before June 30, 2012
df_raw[,action_date_year_quarter:=as.Date(as.yearqtr(as.Date(action_date)),frac = 1)]
df_raw_first=subset(df_raw,action_date_year_quarter<=max(df$action_date_year_quarter))

# select fao from small projects in quarters of fiscal year 2010
df_raw_first[,sb_fao_before_qp:=ifelse(contracting_officers_determination_of_business_size_code=='S' &
                          action_date_year_quarter<as.Date("2010-12-31"),
                                   federal_action_obligation,0)]

# For each firm, get total fao from small projects in quarters of fiscal year 2010
small_projects_fao=df_raw_first[,sum(sb_fao_before_qp), by= c('recipient_duns')]
setnames(small_projects_fao, "V1", "sum_fao")

# Get each firm's sales in FY 2010 from Intellect data 
intellect_data=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/govt_weight_per_recipient.csv',select=c('recipient_duns','sales_fiscal_year','sales_volume'))
intellect_data=subset(intellect_data,sales_fiscal_year=="2010 Sales Volume")

# merge the sales data with fao data
small_projects_fao=merge(small_projects_fao,
                         intellect_data,
                         by='recipient_duns',
                         all=TRUE)

# We don't have sales data for all firms in intellect and some sales are 0 
small_projects_fao[, rho:=ifelse(sales_fiscal_year=="2010 Sales Volume" & sales_volume>0,
                                 sum_fao/(sales_volume),NaN)] 
small_projects_fao[,rescaled_rho:=rescale(rho)]

# get empirical distribution of rho, defined by alpha
small_projects_fao=small_projects_fao[order(rho)]
denom=nrow(subset(small_projects_fao,sales_fiscal_year=="2010 Sales Volume" & sales_volume>0))

small_projects_fao[,rank_firm:=ifelse(sales_fiscal_year=="2010 Sales Volume" & sales_volume>0,
                                  seq.int(nrow(small_projects_fao))/denom,NaN)]

small_projects_fao=small_projects_fao[,c('recipient_duns','rank_firm','rescaled_rho','rho')]

reg_df=merge(reg_df,small_projects_fao,by='recipient_duns',all=T)
```

## Portfolio Effects: Discrete

* See [Jie’s notes](https://github.com/QuickPay-Operational-Performance/Data-and-code/blob/master/notes/Portfolio%20model%2B0308.pdf) for details.
* Let $Rank_f^{(k)}$ be an indicator for firm being in the k-th tercile of $Rank$.Define:
  * $Medium_i = Treat_i * Rank_f^{(2)}$
  * $High_i = Treat_i * Rank_f^{(3)}$

$$\begin{aligned} Delay_{it}&=&\beta_0+\beta_1 Treat_i + \beta_2 Medium_i+\beta_3 High_i +\beta_4 Post_t\\ && +\beta_5( Treat_i\times Post_t) + \beta_6(Medium_i\times Post_t) + \beta_7(High_i\times Post_t) + \epsilon_{it} \end{aligned}$$

```{r portfolio_regs_discrete, echo=FALSE, results='asis'}

reg_df[,rank_tercile:=ntile(rank_firm,3)]

# This will also set all NA rank_terciles to zero
reg_df[,medium_i:=ifelse(rank_tercile==2 & treat_i==1,1,0)]
reg_df[,high_i:=ifelse(rank_tercile==3 & treat_i==1,1,0)]

# set values to NA for those observations whose firm's rank is not defined
reg_df[,medium_i:=ifelse(is.na(rank_tercile),NaN,medium_i)]
reg_df[,high_i:=ifelse(is.na(rank_tercile),NaN,high_i)]

baseline_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter+recipient_duns| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

vars.order=c('treat_i',
             'medium_i',
             'high_i',
             'post_t',
             'treat_i:post_t',
             'treat_i:medium_i:post_t',
             'treat_i:high_i:post_t')

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Discrete Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Medium_i$",
                               "$High_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$Treat_i \\times Post_t \\times Medium_i$",
                               "$Treat_i \\times Post_t \\times High_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

## Portfolio Effects: Continuous

* See [Jie’s notes](https://github.com/QuickPay-Operational-Performance/Data-and-code/blob/master/notes/Portfolio%20model%2B0308.pdf) for details.
* Define $\theta_i = Treat_i*Rank_f$

$$ \begin{aligned} Delay_{it}&=&\beta_0+\beta_1 Treat_i + \beta_2 \theta_i+\beta_3 \theta_i^2+\beta_4 Post_t\\&& + \beta_5 (Treat_i\times Post_t) + \beta_6 (\theta_i\times Post_t) +\beta_7 (\theta_i^2\times Post_t)+\epsilon_{it} \end{aligned} $$

```{r portfolio_regs_continuous, echo=FALSE, results='asis'}

reg_df[,theta_i:=rank_firm*treat_i]

baseline_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter+recipient_duns| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

vars.order=c('treat_i',
             'theta_i',
             'I(theta_i^2)',
             'post_t',
             'treat_i:post_t',
             'theta_i:post_t',
             'I(theta_i^2):post_t')

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Discrete Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$\\theta_i$",
                               "$\\theta_i^2$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$\\theta_i \\times Post_t$",
                               "$\\theta_i^2 \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

<!-- ## Continuous Treatment  -->

<!-- ```{r trying_sthn, eval=False} -->
<!-- a=subset(df_raw_first,action_date_fiscal_year==2010)[,n_distinct(contract_award_unique_key), by= c('recipient_duns')] -->
<!-- a_small=subset(df_raw_first,action_date_fiscal_year==2010 & contracting_officers_determination_of_business_size_code=="S")[,n_distinct(contract_award_unique_key), by= c('recipient_duns')] -->
<!-- setnames(a,"V1","total_num_of_projects") -->
<!-- setnames(a_small,"V1","num_of_small_projects") -->
<!-- a1=merge(a,a_small,on=recipient_duns,all=T) -->
<!-- a1[is.na(a1)] <- 0 -->
<!-- a1[,pc_small_projects:=num_of_small_projects*100/total_num_of_projects] -->
<!-- a1[,ratio_small_projects:=num_of_small_projects/total_num_of_projects] -->
<!-- a1=merge(a1,reg_df,on=recipient_duns,all=T) -->

<!-- baseline_reg=felm(winsorized_delay~ -->
<!--                     ratio_small_projects+ -->
<!--                     post_t:ratio_small_projects+ -->
<!--                     post_t| -->
<!-- 0| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=a1, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- controls_reg=felm(winsorized_delay~ -->
<!--                     ratio_small_projects+ -->
<!--                     post_t:ratio_small_projects+ -->
<!--                     post_t+ -->
<!--                     winsorized_initial_duration_in_days_i+ -->
<!--                     winsorized_initial_budget_i+ -->
<!--                     number_of_offers_received+ -->
<!--                     post_t:winsorized_initial_duration_in_days_i+ -->
<!--                     post_t:winsorized_initial_budget_i+ -->
<!--                     post_t:number_of_offers_received| -->
<!-- 0| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=a1, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- controls_and_time_task_fe_reg=felm(winsorized_delay~ -->
<!--                     ratio_small_projects+ -->
<!--                     post_t:ratio_small_projects+ -->
<!--                     winsorized_initial_duration_in_days_i+ -->
<!--                     winsorized_initial_budget_i+ -->
<!--                     number_of_offers_received+ -->
<!--                     post_t:winsorized_initial_duration_in_days_i+ -->
<!--                     post_t:winsorized_initial_budget_i+ -->
<!--                     post_t:number_of_offers_received| -->
<!-- action_date_year_quarter+product_or_service_code| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=a1, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- controls_and_all_fe_reg=felm(winsorized_delay~ -->
<!--                     post_t:ratio_small_projects+ -->
<!--                     winsorized_initial_duration_in_days_i+ -->
<!--                     winsorized_initial_budget_i+ -->
<!--                     number_of_offers_received+ -->
<!--                     post_t:winsorized_initial_duration_in_days_i+ -->
<!--                     post_t:winsorized_initial_budget_i+ -->
<!--                     post_t:number_of_offers_received| -->
<!-- recipient_duns+action_date_year_quarter+product_or_service_code| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=a1, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- ``` -->
<!-- $$ \begin{aligned} -->
<!-- Delay_{it} &=& \beta_0 + \beta_1 Rank_f + \beta_2 Treat_i + \beta_3 Post_t + \beta_4 (Post_t \times Treat_i) + \\  -->
<!-- && \beta_5 (Post_t \times Treat_i \times Rank_f) + \epsilon_{it} -->
<!-- \end{aligned}$$ -->

<!-- * $Rank_f$ is time-invariant so interaction with $Post_t$ irrelevant -->
<!-- * In this model, we have: -->
<!--    * Small + Before QP = $\beta_0 + \beta_1 Rank_f + \beta_2$ -->
<!--    * Large + Before QP = $\beta_0 +\beta_1 Rank_f$ -->
<!--    * $\Delta_{before}$ = $\beta_2$ -->
<!--    * Small + After QP = $\beta_0 + \beta_1 Rank_f + \beta_2+\beta_3 + \beta_4+\beta_5 Rank_f$ -->
<!--    * Large + After QP = $\beta_0 +\beta_1 Rank_f + \beta_3$ -->
<!--    * $\Delta_{after}$ = $\beta_2+\beta_4+\beta_5 Rank_f$ -->
<!--    * Treatment effect = $\Delta_{after} - \Delta_{before} = \beta_4 + \beta_5 Rank_f$ -->
<!-- * One percentage point increase in $Rank_f$ increases the treatment effect by $\beta_5$. Put differently, quickpay increases small project delays by $\beta_4$ days for all firms, and an additional $\beta_5*Rank_f$ days of delay would occur based on the firm’s rank order.  -->

<!-- ```{r rank_continuous, echo=FALSE, results='asis'} -->

<!-- baseline_reg=felm(winsorized_delay~treat_i+post_t+rank_firm+ -->
<!-- post_t:treat_i+ -->
<!-- post_t:treat_i:rank_firm| -->
<!-- 0| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=reg_df, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- time_fe_reg=felm(winsorized_delay~treat_i+rank_firm+ -->
<!-- post_t:treat_i+ -->
<!-- post_t:treat_i:rank_firm| -->
<!-- action_date_year_quarter| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=reg_df, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- time_and_task_fe_reg=felm(winsorized_delay~treat_i+rank_firm+ -->
<!-- post_t:treat_i+ -->
<!-- post_t:treat_i:rank_firm| -->
<!-- product_or_service_code+action_date_year_quarter| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=reg_df, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- before_qp_firms=unique(subset(reg_df,post_t==0)$recipient_duns) -->
<!-- after_qp_firms=unique(subset(reg_df,post_t==1)$recipient_duns) -->
<!-- firms_in_both_periods=intersect(before_qp_firms,after_qp_firms) -->

<!-- controls_reg=felm(winsorized_delay~ -->
<!--                     treat_i+ -->
<!--                     rank_firm+ -->
<!--                     post_t:treat_i+ -->
<!--                     post_t:treat_i:rank_firm+ -->
<!--                     post_t+ -->
<!--                     winsorized_initial_duration_in_days_i+ -->
<!--                     winsorized_initial_budget_i+ -->
<!--                     number_of_offers_received+ -->
<!--                     post_t:winsorized_initial_duration_in_days_i+ -->
<!--                     post_t:winsorized_initial_budget_i+ -->
<!--                     post_t:number_of_offers_received| -->
<!-- 0| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=subset(reg_df, recipient_duns%in% firms_in_both_periods), -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- vars.order=c('treat_i', -->
<!--              'rank_second_tercile', -->
<!--              'rank_third_tercile', -->
<!--              'post_t', -->
<!--              'treat_i:post_t:rank_first_tercile', -->
<!--              'treat_i:post_t:rank_second_tercile', -->
<!--              'treat_i:post_t:rank_second_tercile') -->

<!-- stargazer(baseline_reg, -->
<!--           time_fe, -->
<!--           time_and_task_fe_reg, -->
<!--           digits=2, -->
<!--           digits.extra=2, -->
<!--           title = "Effect of Treatment Intensity: Quickpay 2009-2011", -->
<!--           dep.var.labels="$Delay_{it}$ (in days)", -->
<!--           dep.var.caption = "", -->
<!--           order=paste0("^", vars.order , "$"), -->
<!--           covariate.labels = c("$Treat_i$", -->
<!--                                "$Rank_{(2)}$", -->
<!--                                "$Rank_{(3)}$", -->
<!--                                "$Post_t$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(1)}$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(2)}$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(3)}$", -->
<!--                                "Constant"), -->
<!--           object.names=FALSE,  -->
<!--           model.numbers=TRUE, -->
<!--           font.size = "small", -->
<!--           omit.stat=c("f", "ser"), -->
<!--           column.sep.width = "-2pt", -->
<!--           add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes","Yes","Yes"), -->
<!--                            c("Task Fixed Effects","No","No","No","Yes","Yes"), -->
<!--                            c("Firm Fixed Effects","No","No","No","No","Yes"), -->
<!--                            c("Duration, Budget, Bids","No","No","Yes","Yes","Yes"), -->
<!--                            c("$Post_t \\times$    (Duration, Budget, Bids)","No","No","Yes","Yes","Yes")), -->
<!--           omit=c('winsorized_initial_duration_in_days_i', -->
<!--                   'winsorized_initial_budget_i', -->
<!--                    'number_of_offers_received', -->
<!--                    'post_t:winsorized_initial_duration_in_days_i', -->
<!--                    'post_t:winsorized_initial_budget_i', -->
<!--                    'post_t:number_of_offers_received'), -->
<!--          table.placement = "H", -->
<!--          style="default", -->
<!--          notes=c("Each observation is a project-quarter.", -->
<!--                   "SEs are robust and clustered at the project level."), -->
<!--          header=F) -->

<!-- ``` -->

<!-- ```{r quadratic_rank_continuous, echo=FALSE, results='asis'} -->

<!-- quadratic_reg=felm(winsorized_delay~treat_i+post_t+I(100*rank_firm)+ -->
<!-- post_t:treat_i+ -->
<!-- post_t:treat_i:I(100*rank_firm)+ -->
<!-- post_t:treat_i:I((100*rank_firm)^2)| -->
<!-- 0| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=reg_df, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- quadratic_time_fe_reg=felm(winsorized_delay~treat_i+I(100*rank_firm)+ -->
<!-- post_t:treat_i+ -->
<!-- post_t:treat_i:I(100*rank_firm)+ -->
<!-- post_t:treat_i:I((100*rank_firm)^2)| -->
<!-- action_date_year_quarter| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=reg_df, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->

<!-- quadratic_time_and_task_fe_reg=felm(winsorized_delay~treat_i+I(100*rank_firm)+ -->
<!-- post_t:treat_i+ -->
<!-- post_t:treat_i:I(100*rank_firm)+ -->
<!-- post_t:treat_i:I((100*rank_firm)^2)| -->
<!-- product_or_service_code+action_date_year_quarter| # no fixed effects -->
<!-- 0| # no IV -->
<!-- contract_award_unique_key, # clustered at project level -->
<!-- data=reg_df, -->
<!-- exactDOF = TRUE, -->
<!-- cmethod = "reghdfe") -->
<!-- ``` -->

<!-- Let $Rank_{(k)}$ is an indicator for firms in $k-th$ tericle of $r_f$. -->

<!-- $$ \begin{aligned}  -->
<!-- Delay_{it}&=&\beta_0 + \beta_1 Treat_i + \beta_2 Rank_{(2)} +\beta_3 Rank_{(3)} + \beta_4 Post_t \\ -->
<!--           && + \beta_5 (Post_t \times Treat_i \times Rank_{(1)}) + \beta_6 (Post_t \times Treat_i \times Rank_{(2)})\\ -->
<!--           && + \beta_7 (Post_t \times Treat_i \times Rank_{(3)}) + \epsilon_{it} -->
<!-- \end{aligned}$$ -->

<!-- * Treatment effect for firms in first tercile: $\beta_5$ -->
<!-- * Treatment effect for firms in second tercile: $\beta_6$ -->
<!-- * Treatment effect for firms in third tercile: $\beta_7$ -->
<!-- * $Rank_{(k)}$ is time-invariant -- so $Post_t \times Rank_{(k)}$ does not make sense -->

<!-- ```{r define_rank_terciles, echo=FALSE, results='asis'} -->

<!-- reg_df[,rank_tercile:=ntile(rank_firm,3)] -->
<!-- reg_df[,rank_first_tercile:=ifelse(rank_tercile==1,1,0)] -->
<!-- reg_df[,rank_second_tercile:=ifelse(rank_tercile==2,1,0)] -->
<!-- reg_df[,rank_third_tercile:=ifelse(rank_tercile==3,1,0)] -->
<!-- ``` -->


<!-- ```{r portfolio_regs, echo=FALSE, results='asis'} -->

<!-- baseline_reg=felm(winsorized_delay~treat_i+ -->
<!--                     post_t:treat_i:rank_first_tercile+ -->
<!--                     post_t:treat_i:rank_second_tercile+ -->
<!--                     post_t:treat_i:rank_third_tercile+ -->
<!--                     +post_t+ -->
<!--                     rank_second_tercile+ -->
<!--                     rank_third_tercile| -->
<!--                     0| # no fixed effects -->
<!--                     0| # no IV -->
<!--                     contract_award_unique_key, # clustered at project level -->
<!--                   data=reg_df, -->
<!--                   exactDOF = TRUE, -->
<!--                   cmethod = "reghdfe") -->

<!-- time_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i:rank_first_tercile+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             rank_second_tercile+ -->
<!--                             rank_third_tercile| -->
<!--                             action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- controls_and_time_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i:rank_first_tercile+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             rank_second_tercile+ -->
<!--                             rank_third_tercile+ -->
<!--                             winsorized_initial_duration_in_days_i+ -->
<!--                             winsorized_initial_budget_i+ -->
<!--                             number_of_offers_received+ -->
<!--                             post_t:winsorized_initial_duration_in_days_i+ -->
<!--                             post_t:winsorized_initial_budget_i+ -->
<!--                             post_t:number_of_offers_received| -->
<!--                             action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- # time fixed effects also included in the following specs -->
<!-- controls_and_task_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i:rank_first_tercile+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             rank_second_tercile+ -->
<!--                             rank_third_tercile+ -->
<!--                             winsorized_initial_duration_in_days_i+ -->
<!--                             winsorized_initial_budget_i+ -->
<!--                             number_of_offers_received+ -->
<!--                             post_t:winsorized_initial_duration_in_days_i+ -->
<!--                             post_t:winsorized_initial_budget_i+ -->
<!--                             post_t:number_of_offers_received| -->
<!--                             product_or_service_code+action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- controls_and_firm_task_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i:rank_first_tercile+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             winsorized_initial_duration_in_days_i+ -->
<!--                             winsorized_initial_budget_i+ -->
<!--                             number_of_offers_received+ -->
<!--                             post_t:winsorized_initial_duration_in_days_i+ -->
<!--                             post_t:winsorized_initial_budget_i+ -->
<!--                             post_t:number_of_offers_received| -->
<!--                             recipient_duns+product_or_service_code+action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- vars.order=c('treat_i', -->
<!--              'rank_second_tercile', -->
<!--              'rank_third_tercile', -->
<!--              'post_t', -->
<!--              'treat_i:post_t:rank_first_tercile', -->
<!--              'treat_i:post_t:rank_second_tercile', -->
<!--              'treat_i:post_t:rank_second_tercile') -->

<!-- stargazer(baseline_reg, -->
<!--           time_fe, -->
<!--           controls_and_time_fe, -->
<!--           controls_and_task_fe, -->
<!--           controls_and_firm_task_fe, -->
<!--           digits=2, -->
<!--           digits.extra=2, -->
<!--           title = "Effect of Treatment Intensity: Quickpay 2009-2011", -->
<!--           dep.var.labels="$Delay_{it}$ (in days)", -->
<!--           dep.var.caption = "", -->
<!--           order=paste0("^", vars.order , "$"), -->
<!--           covariate.labels = c("$Treat_i$", -->
<!--                                "$Rank_{(2)}$", -->
<!--                                "$Rank_{(3)}$", -->
<!--                                "$Post_t$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(1)}$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(2)}$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(3)}$", -->
<!--                                "Constant"), -->
<!--           object.names=FALSE,  -->
<!--           model.numbers=TRUE, -->
<!--           font.size = "small", -->
<!--           omit.stat=c("f", "ser"), -->
<!--           column.sep.width = "-2pt", -->
<!--           add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes","Yes","Yes"), -->
<!--                            c("Task Fixed Effects","No","No","No","Yes","Yes"), -->
<!--                            c("Firm Fixed Effects","No","No","No","No","Yes"), -->
<!--                            c("Duration, Budget, Bids","No","No","Yes","Yes","Yes"), -->
<!--                            c("$Post_t \\times$    (Duration, Budget, Bids)","No","No","Yes","Yes","Yes")), -->
<!--           omit=c('winsorized_initial_duration_in_days_i', -->
<!--                   'winsorized_initial_budget_i', -->
<!--                    'number_of_offers_received', -->
<!--                    'post_t:winsorized_initial_duration_in_days_i', -->
<!--                    'post_t:winsorized_initial_budget_i', -->
<!--                    'post_t:number_of_offers_received'), -->
<!--          table.placement = "H", -->
<!--          style="default", -->
<!--          notes=c("Each observation is a project-quarter.", -->
<!--                   "SEs are robust and clustered at the project level."), -->
<!--          header=F) -->
<!-- ``` -->

<!-- <!-- ## Relative to First Tercile --> -->

<!-- <!-- $$ \begin{aligned}  --> -->
<!-- <!-- Delay_{it}&=&\beta_0 + \beta_1 Treat_i + \beta_2 Rank_{(2)} +\beta_3 Rank_{(3)} + \beta_4 Post_t \\ --> -->
<!-- <!--           && + \beta_5 (Post_t \times Treat_i) + \beta_6 (Post_t \times Treat_i \times Rank_{(2)})\\ --> -->
<!-- <!--           && + \beta_7 (Post_t \times Treat_i \times Rank_{(3)}) + \epsilon_{it} --> -->
<!-- <!-- \end{aligned}$$ --> -->

<!-- ```{r portfolio_relative_regs, eval= FALSE, echo=FALSE} -->

<!-- baseline_reg=felm(winsorized_delay~treat_i+ -->
<!--                     post_t:treat_i+ -->
<!--                     post_t:treat_i:rank_second_tercile+ -->
<!--                     post_t:treat_i:rank_third_tercile+ -->
<!--                     +post_t+ -->
<!--                     rank_second_tercile+ -->
<!--                     rank_third_tercile| -->
<!--                     0| # no fixed effects -->
<!--                     0| # no IV -->
<!--                     contract_award_unique_key, # clustered at project level -->
<!--                   data=reg_df, -->
<!--                   exactDOF = TRUE, -->
<!--                   cmethod = "reghdfe") -->

<!-- time_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             rank_second_tercile+ -->
<!--                             rank_third_tercile| -->
<!--                             action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- controls_and_time_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             rank_second_tercile+ -->
<!--                             rank_third_tercile+ -->
<!--                             winsorized_initial_duration_in_days_i+ -->
<!--                             winsorized_initial_budget_i+ -->
<!--                             number_of_offers_received+ -->
<!--                             post_t:winsorized_initial_duration_in_days_i+ -->
<!--                             post_t:winsorized_initial_budget_i+ -->
<!--                             post_t:number_of_offers_received| -->
<!--                             action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- # time fixed effects also included in the following specs -->
<!-- controls_and_task_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             rank_second_tercile+ -->
<!--                             rank_third_tercile+ -->
<!--                             winsorized_initial_duration_in_days_i+ -->
<!--                             winsorized_initial_budget_i+ -->
<!--                             number_of_offers_received+ -->
<!--                             post_t:winsorized_initial_duration_in_days_i+ -->
<!--                             post_t:winsorized_initial_budget_i+ -->
<!--                             post_t:number_of_offers_received| -->
<!--                             product_or_service_code+action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- controls_and_firm_task_fe=felm(winsorized_delay~treat_i+ -->
<!--                             post_t:treat_i+ -->
<!--                             post_t:treat_i:rank_second_tercile+ -->
<!--                             post_t:treat_i:rank_third_tercile+ -->
<!--                             winsorized_initial_duration_in_days_i+ -->
<!--                             winsorized_initial_budget_i+ -->
<!--                             number_of_offers_received+ -->
<!--                             post_t:winsorized_initial_duration_in_days_i+ -->
<!--                             post_t:winsorized_initial_budget_i+ -->
<!--                             post_t:number_of_offers_received| -->
<!--                             recipient_duns+product_or_service_code+action_date_year_quarter| -->
<!--                             0| -->
<!--                             contract_award_unique_key, -->
<!--                           data=reg_df,  -->
<!--                           exactDOF = TRUE,  -->
<!--                           cmethod = "reghdfe") -->

<!-- vars.order=c('treat_i', -->
<!--              'rank_second_tercile', -->
<!--              'rank_third_tercile', -->
<!--              'post_t', -->
<!--              'treat_i:post_t', -->
<!--              'treat_i:post_t:rank_second_tercile', -->
<!--              'treat_i:post_t:rank_second_tercile') -->

<!-- stargazer(baseline_reg, -->
<!--           time_fe, -->
<!--           controls_and_time_fe, -->
<!--           controls_and_task_fe, -->
<!--           controls_and_firm_task_fe, -->
<!--           digits=2, -->
<!--           digits.extra=2, -->
<!--           title = "Effect of Treatment Intensity: Quickpay 2009-2011", -->
<!--           dep.var.labels="$Delay_{it}$ (in days)", -->
<!--           dep.var.caption = "", -->
<!--           order=paste0("^", vars.order , "$"), -->
<!--           covariate.labels = c("$Treat_i$", -->
<!--                                "$Rank_{(2)}$", -->
<!--                                "$Rank_{(3)}$", -->
<!--                                "$Post_t$", -->
<!--                                "$Treat_i \\times Post_t$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(2)}$", -->
<!--                                "$Treat_i \\times Post_t \\times Rank_{(3)}$", -->
<!--                                "Constant"), -->
<!--           object.names=FALSE,  -->
<!--           model.numbers=TRUE, -->
<!--           font.size = "small", -->
<!--           omit.stat=c("f", "ser"), -->
<!--           column.sep.width = "-2pt", -->
<!--           add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes","Yes","Yes"), -->
<!--                            c("Task Fixed Effects","No","No","No","Yes","Yes"), -->
<!--                            c("Firm Fixed Effects","No","No","No","No","Yes"), -->
<!--                            c("Duration, Budget, Bids","No","No","Yes","Yes","Yes"), -->
<!--                            c("$Post_t \\times$    (Duration, Budget, Bids)","No","No","Yes","Yes","Yes")), -->
<!--           omit=c('winsorized_initial_duration_in_days_i', -->
<!--                   'winsorized_initial_budget_i', -->
<!--                    'number_of_offers_received', -->
<!--                    'post_t:winsorized_initial_duration_in_days_i', -->
<!--                    'post_t:winsorized_initial_budget_i', -->
<!--                    'post_t:number_of_offers_received'), -->
<!--          table.placement = "H", -->
<!--          style="default", -->
<!--          notes=c("Each observation is a project-quarter.", -->
<!--                   "SEs are robust and clustered at the project level."), -->
<!--          header=F) -->
<!-- ``` -->
