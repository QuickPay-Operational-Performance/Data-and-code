---
title: "First Implementation of QuickPay (2009-2012)"
date: " `r format(Sys.time(), '%b %d, %Y')`"
output: 
  pdf_document :
    keep_tex: true
    number_sections: true
header-includes:
 \usepackage{booktabs,longtable,dcolumn}
 \usepackage{multirow,array}
 \usepackage{wrapfig,float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r packages,warning=FALSE,message=FALSE,include=FALSE}
library(openxlsx)
library(tidyverse)
library(dplyr)
library(pryr)
library(lfe) # linear fixed effects 
library(DescTools) 
library(zoo) # for year quarter
library(stargazer)
library(broom)
library(data.table)
library(scales)
``` 
```{r read_data, include=FALSE}
# read quarterly resampled data
df=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/resampled_qp_data/quickpay_resampled_fy10_to_fy12.csv')

# specify date columns
date_cols=c("action_date_year_quarter","last_reported_start_date","last_reported_end_date")
df[,(date_cols):= lapply(.SD, as.Date), .SDcols = date_cols]

# restrict to quarter ending June 30, 2012
df=subset(df,as.Date(action_date_year_quarter)<max(as.Date(df$action_date_year_quarter)))
# data is truncated at July 1, 2012 -- 
# so quarter ending Sept 30, 2012 will only have values as of July 1, 2012

df_first_reported=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/qp_data_first_reported.csv')
# contains time-invariant contract characteristics -- info when contract first appeared in the data
```
```{r assign_variables_1, include=FALSE}
# Assign variables: Delay, Winsorized Delay, Post_t, Treat_i

# sort by contract id and date 
df=df[order(contract_award_unique_key,
            action_date_year_quarter)]

# determine quarter-to-quarter delay
df[,delay:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1), 
                  last_reported_end_date-lag(last_reported_end_date,1),NaN)]

# winsorize quarter-to-quarter delay
df[,winsorized_delay:=Winsorize(delay,na.rm=TRUE)]

#Post_t: A dummy that period t is post-treatment
df[,post_t:=ifelse(action_date_year_quarter>as.Date("2011-04-27"),1,0)]
# quickpay implemented on 27 April 2011. So all quarters starting 30 June 2011 will be in post-period

#Treat_i: A dummy that contract i is in the treatment group
df[,treat_i:=ifelse(business_type=="S",1,0)]
# quickpay was implemented for small business contracts
```
```{r assign_variables_2, include=FALSE}
# Assign variables: ContractFinancing_i, Competition_i, PerformanceBased_i, Financial_Aid_i
df_first_reported[,contract_financing_i:=ifelse(!is.null(contract_financing_code)&
                                       !contract_financing_code%in%c("Z", ""),1,0)]
#### 
# unique(df_first_reported[,c('extent_competed','extent_competed_code')])
# df_first_reported[,competitively_awarded_i:=ifelse(!is.null(extent_competed_code)&
#                                           !extent_competed_code%in%c("","G","B", "C"),1,0)]

# E: FOLLOW ON TO COMPETED ACTION
df_first_reported[,competitively_awarded_i:=ifelse(!is.null(extent_competed_code)&
                                          !extent_competed_code%in%c("","G","B", "C","E"),1,0)]
#### 
df_first_reported[,performance_based_contract_i:=ifelse(performance_based_service_acquisition_code=='Y',1,0)]

df_first_reported[,performance_based_contract_i:=ifelse(performance_based_service_acquisition_code=='X',NaN,performance_based_contract_i)]

#### 
df_first_reported[,receives_financial_aid_i:=ifelse(receives_grants=='t'|
                                           c8a_program_participant=='t',1,0)]
#### 
df_first_reported[,receives_contracts_and_financial_aid_i:=ifelse(receives_contracts_and_grants=='t'|
                                                         receives_grants=='t'|
                                                         c8a_program_participant=='t',1,0)]

df_first_reported[,winsorized_initial_duration_in_days_i:=Winsorize(as.numeric(
                               as.Date(period_of_performance_current_end_date)-
                               as.Date(period_of_performance_start_date)),na.rm=T)]
df_first_reported[,winsorized_initial_budget_i:=Winsorize(base_and_all_options_value,na.rm=T)]

select_cols=c("contract_award_unique_key",
              "number_of_offers_received",
              "contract_financing_i",
              "competitively_awarded_i",
              "performance_based_contract_i",
              "receives_financial_aid_i",
              "receives_contracts_and_financial_aid_i",
              "winsorized_initial_duration_in_days_i",
              "winsorized_initial_budget_i")

df_first_reported_cols=df_first_reported[,..select_cols]
# not necessary but speed efficient to set keys
setkey(df_first_reported_cols,contract_award_unique_key)
setkey(df,contract_award_unique_key)
```
```{r combine_dfs, include=FALSE}
# Combine all variables into dataframe needed for regression 
reg_df=merge(df,
             df_first_reported_cols,
             all.x = TRUE, # keep values in df, add columns of df_first_reported_cols
             by=c("contract_award_unique_key"))
```

# Delays over Time

```{r plot, echo=FALSE, results='asis'}
mean_delay=df[!is.na(winsorized_delay) & action_date_year_quarter<as.Date('2012-06-30'), 
              mean(winsorized_delay),  
              by = c('action_date_year_quarter','business_type')]
mean_delay[,year_quarter:=format(action_date_year_quarter,"%Y-%b")]
mean_delay=mean_delay[order(action_date_year_quarter,business_type)]

ggplot(mean_delay, aes(x=year_quarter,
               y=V1, 
               group = business_type, 
               shape=business_type, 
               linetype=business_type))+
    geom_line() +    
    scale_x_discrete(limits=mean_delay$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average delay per quarter (in days)")+  
    annotate("text", label = "QuickPay\n implemented", x = 8, y = 50,color="dimgrey")+
    geom_vline(xintercept = 10.2, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    scale_linetype_discrete(name="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))
```

# Notation 

* Project $i$, Year-Quarter $t$
* $X_i$ denotes project level controls: initial duration, initial budget, number of offers received
* $\mu_t,\theta_{firm},\lambda_{task}$: Year-Quarter, Firm, and Product/Service code Fixed effects
* All continuous variables are winsorized at the 5\% level
$$ Treat_i = \begin{cases} 1, \text{ if project } i \text{ is a small business}\\
0, \text{ otherwise} \end{cases}$$
$$ Post_t = \begin{cases} 1, \text{ if year-quarter } t > \text{ April 27, 2011}\\
0, \text{ otherwise} \end{cases}$$


# Summary Statistics

```{r summary_stats, echo=F, eval = F}

# get mean and std_dev of continuous variables 
cols_cts=c("business_type",
              "winsorized_delay",
              "winsorized_initial_duration_in_days_i",
              "winsorized_initial_budget_i",
              "post_t")

mean_stats=reg_df[,..cols_cts][, lapply(.SD, mean, na.rm=TRUE), 
                   by=c('business_type','post_t') ]
setnames(mean_stats,c('winsorized_delay',
                     'winsorized_initial_duration_in_days_i',
                     'winsorized_initial_budget_i'),
                     c('mean_delay',
                     'mean_initial_duration_in_days_i',
                     'mean_initial_budget_i'))

sd_stats=reg_df[,..cols_cts][, lapply(.SD, sd, na.rm=TRUE), 
                 by=c('business_type','post_t') ]
setnames(sd_stats,c('winsorized_delay',
                     'winsorized_initial_duration_in_days_i',
                     'winsorized_initial_budget_i'),
                     c('sd_delay',
                     'sd_initial_duration_in_days_i',
                     'sd_initial_budget_i'))

# get num unique values of discrete variables
cols_discrete=c("business_type",
              "recipient_duns",
              "product_or_service_code",
              "contract_award_unique_key",
              "post_t")

num_unique_stats=reg_df[,..cols_discrete][, lapply(.SD, n_distinct, na.rm=TRUE), 
                         by=c('business_type','post_t')]

setnames(num_unique_stats,c("recipient_duns",
                            "product_or_service_code",
                            "contract_award_unique_key"),
                     c('number_of_firms',
                     'number_of_tasks',
                     'number_of_projects'))

# get sum of values for binary variables
# this is wrong -- same project gets included multiple times, to be fixed
# cols_binary=c("business_type",
#               "contract_financing_i",
#               "competitively_awarded_i",
#               "post_t")
# 
# num_binary_stats=reg_df[,..cols_binary][, lapply(.SD, sum, na.rm=TRUE), 
#                          by=c('business_type','post_t')]
# 
# setnames(num_binary_stats,c("contract_financing_i",
#                            "competitively_awarded_i"),
#                      c('number_of_projects_financed',
#                      'number_of_projects_competed'))


# num_binary_stats[,business_and_time:=paste(business_type,post_t,sep="_and_post")]
num_unique_stats[,business_and_time:=paste(business_type,post_t,sep="_and_post")]
mean_stats[,business_and_time:=paste(business_type,post_t,sep="_and_post")]
sd_stats[,business_and_time:=paste(business_type,post_t,sep="_and_post")]

all_summ=merge(mean_stats,
      sd_stats,
      on=business_and_time)

all_summ=merge(all_summ,
               num_binary_stats,
               on=business_and_time)

all_summ=merge(all_summ,
               num_unique_stats,
               on=business_and_time)

path='/Users/vibhutidhingra/Desktop/research/Git:Github/QuickPay/qp_data_and_code/qp_first_implementation/'
# write.xlsx(all_summ, paste0(path,'summary_stats.xlsx'))
```
# Parallel Trends Test

Let $Time$ denote $q$-th quarter since the beginning of time horizon. For $Post_t =0$, we run the following regression:
$$ Delay_{it} = \alpha+\beta_0 Treat_i + \beta_1 (Treat_i \times Time) + \beta_2 X_i + \mu_t + \theta_{firm} + \lambda_{task} +\epsilon_{it}$$
The coefficient of interest is $\beta_1$. If this is significant, we would find evidence of a linear time trend before quickpay implementation -- violating the parallel trends assumption.
```{r parallel_trends_test, echo=FALSE, results='asis'}
df_qn<-unique(reg_df,by='action_date_year_quarter')[,"action_date_year_quarter"]
df_qn=df_qn[order(action_date_year_quarter)][,quarter_number:=seq.int(nrow(df_qn))]
reg_df=merge(reg_df,df_qn,by='action_date_year_quarter')
cluster_var = "contract_award_unique_key"

# Estimating linear time trend before quickpay was implemented
fixed_vars =  c("action_date_year_quarter",
                "recipient_duns",
                "product_or_service_code")

control_vars=c("winsorized_initial_duration_in_days_i",
               "winsorized_initial_budget_i",
               "number_of_offers_received")

pt_formula=formula(paste("winsorized_delay~treat_i+
                         quarter_number:treat_i+",
                         paste(control_vars,collapse="+"),
                         "|", paste(fixed_vars, collapse= "+"),
                         "| 0 |", cluster_var))

parallel_trend<-felm(pt_formula,
                     data=subset(reg_df,post_t==0), 
                     exactDOF = TRUE, 
                     cmethod = "reghdfe")

stargazer(parallel_trend,
          title = "Linear Time Trend Before QuickPay",
          dep.var.labels   = "$Delay_{it}$ (in days)",
          header=FALSE,
          object.names=FALSE, 
          model.numbers=FALSE,
          font.size = "small",
          digits=2,
          digits.extra=2,
          omit.stat=c("f", "ser"),
          add.lines = list(c("Fixed effects","Firm, Task, and Year-Quarter"),
                           c("Controls","Budget, Duration, Bids")), 
          covariate.labels = c("$Treat_i$", "$Treat_i \\times Time$"),
          omit = control_vars,
          table.placement = "H",
          notes=c("Each observation is a project-quarter.","SEs are robust and clustered at the project level.","Observations are for quarters before quickpay."))
```

# Baseline Regressions

$$ Delay_{it} = \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) + \epsilon_{it}$$ 

$$ \begin{aligned} Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t)\\
&+&  X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r baseline_regressions, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_no_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                           post_t+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_time_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_time_task_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_all_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          title = "Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$","$Post_t$","$Treat_i \\times Post_t$","Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          digits=2,
          digits.extra=2,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Competition 

$$ Competition_i = \begin{cases} 1, \text{ if project was subject to full and open competition}\\ 
                       \text{(extent competed code is not B, C, G, E, or "")}\\
0, \text{ otherwise} \end{cases}$$

**Hypothesis:** 

* QuickPay increased competition for small projects.
* This led to more aggressive bids. That is, contractors quoted unrealistically small timelines for the projects.
* As a result, we should see “artificial delays” on these projects as they revert to their realistic timelines later.
* **Note:** This hypothesis only applies to projects that were signed after QuickPay. We, therefore, need the effect coming from projects that were signed after QuickPay.

```{r competition_plots,echo=FALSE,eval=FALSE}
project_signed_date=unique(df_first_reported[,c('contract_award_unique_key','action_date')])
project_signed_date[,action_date_year_quarter:=as.Date(as.yearqtr(as.Date(action_date)),
                                                       frac = 1)]
setnames(project_signed_date,'action_date_year_quarter','quarter_when_project_signed')

project_signed_date=project_signed_date[,c('contract_award_unique_key',
                                           'quarter_when_project_signed')]

reg_df=merge(reg_df,
             project_signed_date,
             by='contract_award_unique_key')

x= reg_df[,
          n_distinct(business_type),by=c('quarter_when_project_signed',
                                          'product_or_service_code')]
x[,task_qtr:=paste(quarter_when_project_signed,product_or_service_code,sep="_")]
x=subset(x,V1==2)
reg_df[,task_qtr:=paste(quarter_when_project_signed,product_or_service_code,sep="_")]

# Duration
mean_duration=reg_df[!is.na(winsorized_initial_duration_in_days_i)
                  & action_date_year_quarter<as.Date('2012-06-30'),
                   mean(winsorized_initial_duration_in_days_i),
                   by = c('quarter_when_project_signed',
                          'competitively_awarded_i',
                          'business_type')]

mean_duration[,year_qtr:=format(quarter_when_project_signed,"%Y-%b")]
mean_duration[,competitively_awarded_i:=as.factor(competitively_awarded_i)]
mean_duration=mean_duration[order(quarter_when_project_signed,business_type)]

ggplot(subset(mean_duration,competitively_awarded_i==1), 
                        aes(x=year_qtr,
                                                   y=V1, 
                                                   group = business_type,
                                                   shape=business_type, 
                                                   linetype=business_type))+
   ggtitle("Project's Initial Duration")+ # for the main title
   geom_line() +    
   scale_x_discrete(limits=mean_duration$year_qtr)+
   geom_point(size=3)+
   labs(x="Quarter when project signed", y = "Average Initial Duration")+  
   annotate("text", label = "QuickPay\n implemented", x = 20, y = 200,color="dimgrey")+
   geom_vline(xintercept = 23.5, linetype="solid",
              color = "gray", size=1.5)+
   scale_shape_discrete(name  ="business_type",
                        breaks=c("S", "O"),
                        labels=c("Small", "Large"))+
   scale_linetype_discrete(name="business_type",
                           breaks=c("S", "O"),
                           labels=c("Small", "Large"))+
   theme(plot.title = element_text(hjust = 0.5),
         axis.text.x = element_text(angle = 90),
         axis.line = element_line(),
         panel.border = element_blank(),
         panel.background = element_blank(),
         legend.text = element_text(size=12))

# Budget
mean_budget=reg_df[!is.na(winsorized_initial_budget_i)
                  & action_date_year_quarter<as.Date('2012-06-30'),
                   mean(winsorized_initial_budget_i),
                   by = c('quarter_when_project_signed',
                          'competitively_awarded_i',
                          'business_type')]

mean_budget[,year_qtr:=format(quarter_when_project_signed,"%Y-%b")]
mean_budget[,competitively_awarded_i:=as.factor(competitively_awarded_i)]
mean_budget=mean_budget[order(quarter_when_project_signed,business_type)]

ggplot(subset(mean_budget,competitively_awarded_i==1), 
                        aes(x=year_qtr,
                                                   y=V1, 
                                                   group = business_type,
                                                   shape=business_type, 
                                                   linetype=business_type))+
   ggtitle("Project's Initial Budget")+ # for the main title
   geom_line() +    
   scale_x_discrete(limits=mean_budget$year_qtr)+
   geom_point(size=3)+
   labs(x="Quarter when project signed", y = "Average Initial Budget")+  
   annotate("text", label = "QuickPay\n implemented", x = 20, y = 150000,color="dimgrey")+
   geom_vline(xintercept = 23.5, linetype="solid",
              color = "gray", size=1.5)+
   scale_shape_discrete(name  ="business_type",
                        breaks=c("S", "O"),
                        labels=c("Small", "Large"))+
   scale_linetype_discrete(name="business_type",
                           breaks=c("S", "O"),
                           labels=c("Small", "Large"))+
   theme(plot.title = element_text(hjust = 0.5),
         axis.text.x = element_text(angle = 90),
         axis.line = element_line(),
         panel.border = element_blank(),
         panel.background = element_blank(),
         legend.text = element_text(size=12))

# Bids
mean_bids=reg_df[!is.na(number_of_offers_received)
                  & action_date_year_quarter<as.Date('2012-06-30'),
                   mean(number_of_offers_received),
                   by = c('quarter_when_project_signed',
                          'competitively_awarded_i',
                          'business_type')]

mean_bids[,year_qtr:=format(quarter_when_project_signed,"%Y-%b")]
mean_bids[,competitively_awarded_i:=as.factor(competitively_awarded_i)]
mean_bids=mean_bids[order(quarter_when_project_signed,business_type)]

ggplot(subset(mean_bids,competitively_awarded_i==1), 
                        aes(x=year_qtr,
                                                   y=V1, 
                                                   group = business_type,
                                                   shape=business_type, 
                                                   linetype=business_type))+
   ggtitle("Number of Bids")+ # for the main title
   geom_line() +    
   scale_x_discrete(limits=mean_bids$year_qtr)+
   geom_point(size=3)+
   labs(x="Year-Quarter", y = "Average Number of Offers Received")+  
   annotate("text", label = "QuickPay\n implemented", x = 20, y = 5.5,color="dimgrey")+
   geom_vline(xintercept = 23.5, linetype="solid",
              color = "gray", size=1.5)+
   scale_shape_discrete(name  ="business_type",
                        breaks=c("S", "O"),
                        labels=c("Small", "Large"))+
   scale_linetype_discrete(name="business_type",
                           breaks=c("S", "O"),
                           labels=c("Small", "Large"))+
   theme(plot.title = element_text(hjust = 0.5),
         axis.text.x = element_text(angle = 90),
         axis.line = element_line(),
         panel.border = element_blank(),
         panel.background = element_blank(),
         legend.text = element_text(size=12))
```

## Impact on bids, duration, and budget

$$ \begin{aligned}
y_{it} &=& \beta_0 + \beta_1 Treat_i + \beta_2 (Treat_i \times Post_t) \\
&& + \mu_t + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$ 

where $y_{it}$ can be bids, duration, or budget.

```{r competition_all_in_one, echo=F, results='asis'}
bids=felm(number_of_offers_received~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

duration=felm(winsorized_initial_duration_in_days_i~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

budget=felm(winsorized_initial_budget_i~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(bids,
          duration,
          budget,
          digits=2,
          digits.extra=2,
          title = "Effect of Competition After QuickPay: Quickpay 2009-2011",
          dep.var.labels=c("$NumberOfBids_{it}$",
                           "$InitialDuration_{it}$",
                           "$InitialBudget_{it}$"),
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$Treat_i \\times Post_t$"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "0pt",
          add.lines = list(c("Year-Quarter fixed effects",rep("Yes",3)),
                           c("Task fixed effects",rep("Yes",3))),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level.",
                  "Sample restricted to fully competed projects."),
          header=F)
```
## Impact on bids

For competitively awarded projects, we run the following:

$$ \begin{aligned}
NumberOfBids_{it} &=& \beta_0 + \beta_1 Treat_i + \beta_2 Post_t + \beta_3 (Treat_i \times Post_t) \\
&+&X_i + (Post_t \times X_i) + \mu_t + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r competition_bids, echo=FALSE, results='asis'}

baseline_reg=felm(number_of_offers_received~treat_i+
                                  treat_i:post_t+
                                  post_t|
                                  0| # no fixed effects
                                  0| # no IV
                                  contract_award_unique_key, # clustered at project level
                                  data=subset(reg_df,competitively_awarded_i==1),
                                  exactDOF = TRUE,
                                  cmethod = "reghdfe")

time_fe=felm(number_of_offers_received~treat_i+
                                  treat_i:post_t|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

time_task_fe=felm(number_of_offers_received~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(baseline_reg,
          time_fe,
          time_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Competition After QuickPay: Quickpay 2009-2011",
          dep.var.labels="$NumberOfBids_{it}$",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects",rep("No",1),rep("Yes",2)),
                           c("Task Fixed Effects",rep("No",2),rep("Yes",1))),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level.",
                  "Sample restricted to fully competed projects."),
          header=F)
```


## Impact on Initial Duration

```{r competition_duration, echo=FALSE, results='asis'}

baseline_reg=felm(winsorized_initial_duration_in_days_i~treat_i+
                                  treat_i:post_t+
                                  post_t|
                                  0| # no fixed effects
                                  0| # no IV
                                  contract_award_unique_key, # clustered at project level
                                  data=subset(reg_df,competitively_awarded_i==1),
                                  exactDOF = TRUE,
                                  cmethod = "reghdfe")

time_fe=felm(winsorized_initial_duration_in_days_i~treat_i+
                                  treat_i:post_t|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

time_task_fe=felm(winsorized_initial_duration_in_days_i~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

all_fe=felm(winsorized_initial_duration_in_days_i~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter+
                            recipient_duns|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(baseline_reg,
          time_fe,
          time_task_fe,
          all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Competition After QuickPay: Quickpay 2009-2011",
          dep.var.labels="$InitialDuration_{it}$",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects",rep("No",1),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",2),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",3),rep("Yes",1))),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level.",
                  "Sample restricted to fully competed projects."),
          header=F)
```
## Impact on Initial Budget

```{r competition_budget, echo=FALSE, results='asis'}

baseline_reg=felm(winsorized_initial_budget_i~treat_i+
                                  treat_i:post_t+
                                  post_t|
                                  0| # no fixed effects
                                  0| # no IV
                                  contract_award_unique_key, # clustered at project level
                                  data=subset(reg_df,competitively_awarded_i==1),
                                  exactDOF = TRUE,
                                  cmethod = "reghdfe")

time_fe=felm(winsorized_initial_budget_i~treat_i+
                                  treat_i:post_t|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

time_task_fe=felm(winsorized_initial_budget_i~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

all_fe=felm(winsorized_initial_budget_i~treat_i+
                                  treat_i:post_t|
                            product_or_service_code+
                            action_date_year_quarter+
                            recipient_duns|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(baseline_reg,
          time_fe,
          time_task_fe,
          all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Competition After QuickPay: Quickpay 2009-2011",
          dep.var.labels="$InitialBudget_{it}$",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects",rep("No",1),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",2),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",3),rep("Yes",1))),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level.",
                  "Sample restricted to fully competed projects."),
          header=F)
```
## Impact on delays

Define
$$ StartedAfterQP_i = \begin{cases} 1, \text{ if project was signed after QuickPay}\\
0, \text{ otherwise} \end{cases}$$

We run the following model:

$$\begin{aligned} Delay_{it} &=& \beta_0 +\beta_1 Treat_i+ \beta_2 StartedAfterQP_i+ \beta_3 Post_t+ \beta_4 Competitive_i\\ && +  \beta_5 (Treat_i \times Competitive_i) + \beta_6 (Post_t \times Competitive_i)\\ && +  \beta_7 (StartedAfterQP_i \times Competitive_i) +\beta_8 (Treat_i \times Post_t)\\ && + \beta_9 (Treat_i \times Post_t \times Competitive_i) \\ && + \beta_{10} (Treat_i \times Post_t \times StartedAfterQP_i )\\ && + \beta_{11} (Treat_i \times Post_t \times StartedAfterQP_i \times Competitive_i) + \epsilon_{it} \end{aligned}$$

**Interpretation:**

* $\beta_9$ is the difference between treatment effect for competitive and non-competitive projects signed before quickpay.
* $\beta_9 + \beta_{11}$ is the difference between treatment effect for competitive and non-competitive projects signed *after* quickpay.
* $\beta_{11}$ is our coefficient of interest because it tells us how much of the difference is there due to "aggressive bidding" after the policy.

```{r competition_delays_combined, echo= FALSE, results ='asis'}

new_projects_after_quickpay=unique(subset(df_first_reported,action_date>as.Date('2011-04-27'))$contract_award_unique_key)
reg_df[,project_signed_after_quickpay:=ifelse(contract_award_unique_key%in%new_projects_after_quickpay,1,0)]

# assign number of quarters since project started: "project age" in some sense
setorder(reg_df,contract_award_unique_key,action_date_year_quarter)[, 
           project_quarter_age := rowid(contract_award_unique_key)]
reg_df[,project_quarter_tercile:=as.factor(ntile(project_quarter_age,3))]
# Project age is a highly skewed variable
# Including it as fixed effects doesn't work because projects in treatment and control are not always in same "tercile" while controling for everything else. 

baseline_reg=felm(winsorized_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                     post_t|
                                   0| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")

controls_and_no_fe_no_age=felm(winsorized_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                     post_t+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i|
                                   0| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")

controls_and_no_fe=felm(winsorized_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                     post_t+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            project_quarter_tercile|
                                   0| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")

controls_and_time_fe=felm(winsorized_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            project_quarter_tercile|
                                   action_date_year_quarter| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")

controls_time_task_fe=felm(winsorized_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            project_quarter_tercile|
                                   action_date_year_quarter+
                       product_or_service_code| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")

controls_and_all_fe=felm(winsorized_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            project_quarter_tercile|
                                   action_date_year_quarter+
                       product_or_service_code+recipient_duns| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_and_no_fe_no_age,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Competition After QuickPay: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$StartedAfterQP_i$",
                               "$Competitive_i$",
                               "$Post_t$",
                               "$Treat_i \\times Competitive_i$",
                               "$Post_t \\times Competitive_i$",
                               "$StartedAfterQP_i \\times Competitive_i$",
                               "$Treat_i \\times Post_t$",
                               "$Treat_i \\times Post_t \\times Competitive_i$",
                               "$Treat_i \\times Post_t \\times StartedAfterQP_i$",
                               "$Treat_i \\times Post_t \\times StartedAfterQP_i \\times Competitive_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-3pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",5)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",5)),
                           c("Project age",rep("No",2),rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",3),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",4),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",5),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received',
                   'project_quarter_tercile'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)

```

# Impact of Firm's Financial Constraints

## Contract Financing

$$ CF_i = \begin{cases} 1, \text{ if project } i \text{ receives contract financing}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) \\
&+&\beta_3 CF_i + \beta_4 (CF_i \times Post_t) + \beta_5 (Treat_i \times Post_t \times CF_i) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$


```{r contract_financing, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+
                    post_t:treat_i+post_t+
                    contract_financing_i+
                    post_t:contract_financing_i+
                    post_t:treat_i:contract_financing_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

controls_and_no_fe=felm(winsorized_delay~treat_i+
                            post_t+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_time_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_time_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_all_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'contract_financing_i',
              'post_t:contract_financing_i',
              'treat_i:post_t:contract_financing_i')

stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Contract Financing: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CF_i$",
                               "$Post_t \\times CF_i$",
                               "$Post_t \\times CF_i \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",4)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

## Receives Financial Aid

$$ FinancialAid = \begin{cases} 1, \text{ if firm receives grants or is a c8A participant}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) +\beta_3 FinancialAid \\
&+& \beta_4 (FinancialAid \times Post_t) + \beta_5 (Treat_i \times Post_t \times FinancialAid) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r financial_aid, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    receives_financial_aid_i+post_t:receives_financial_aid_i+
                    post_t:treat_i:receives_financial_aid_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

controls_and_no_fe=felm(winsorized_delay~treat_i+
                            post_t+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_time_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_time_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_all_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'receives_financial_aid_i',
              'post_t:receives_financial_aid_i',
              'treat_i:post_t:receives_financial_aid_i')

stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Grants or C8A Participant: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$FinancialAid$",
                               "$Post_t \\times FinancialAid$",
                               "$Post_t \\times FinancialAid \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",4)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

## Receives Contracts and Financial Aid

$$ CFA = \begin{cases} 1, \text{ if firm receives "contracts and grants"}\\ 
                       \text{or grants or is a c8A participant}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) +\beta_3 CFA \\
&+& \beta_4 (CFA \times Post_t) + \beta_5 (Treat_i \times Post_t \times CFA) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r contracts_and_financial_aid, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    receives_contracts_and_financial_aid_i+
                    post_t:receives_contracts_and_financial_aid_i+
                    post_t:treat_i:receives_contracts_and_financial_aid_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

controls_and_no_fe=felm(winsorized_delay~treat_i+
                            post_t+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_time_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_time_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_all_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'receives_contracts_and_financial_aid_i',
              'post_t:receives_contracts_and_financial_aid_i',
              'treat_i:post_t:receives_contracts_and_financial_aid_i')

stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Contracts, Grants, or C8A Participant: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CFA$",
                               "$Post_t \\times CFA$",
                               "$Post_t \\times CFA \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",4)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Firm's rank order

* Consider a project $i$ of firm $f$ in quarter $t$.
* Let $\Pi_{f,2010}$ denote all projects of firm $f$ in Fiscal Year 2010. 
* Define $\rho_f = \sum_{i \in \Pi_{f,2010}} (Treat_i \times FAO_{if})/Sales_{f,\text{2010}}$.
* $\rho_f$ is the fraction of revenue a firm earned from small government projects in Fiscal Year 2010.
* Let $Rank_f = r(\rho_f)/N$ where $r(\rho_f)$ is the rank statistic of $\rho_{f}$ and $N = \text{number of firms}.$ For example, $r(\rho_f)=1$ if $\rho_f=\min(\rho_1,\rho_2,\ldots,\rho_N)$.
* Put simply, $Rank_f$ is a firm's rank order based on the fraction of revenue it earned from small government projects in FY 2010.

```{r fao, include=FALSE}
# read raw data
df_raw=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/qp_data_fy10_to_fy18.csv')

# restrict to quarters on/before June 30, 2012
df_raw[,action_date_year_quarter:=as.Date(as.yearqtr(as.Date(action_date)),frac = 1)]
df_raw_first=subset(df_raw,action_date_year_quarter<=max(df$action_date_year_quarter))

# select fao from small projects in quarters of fiscal year 2010
df_raw_first[,sb_fao_before_qp:=ifelse(contracting_officers_determination_of_business_size_code=='S' &
                          action_date_year_quarter<as.Date("2010-12-31"),
                                   federal_action_obligation,0)]

# For each firm, get total fao from small projects in quarters of fiscal year 2010
small_projects_fao=df_raw_first[,sum(sb_fao_before_qp), by= c('recipient_duns')]
setnames(small_projects_fao, "V1", "sum_fao")

# Get each firm's sales in FY 2010 from Intellect data 
intellect_data=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/govt_weight_per_recipient.csv',select=c('recipient_duns','sales_fiscal_year','sales_volume'))
intellect_data=subset(intellect_data,sales_fiscal_year=="2010 Sales Volume")

# merge the sales data with fao data
small_projects_fao=merge(small_projects_fao,
                         intellect_data,
                         by='recipient_duns',
                         all=TRUE)

# We don't have sales data for all firms in intellect and some sales are 0 
small_projects_fao[, rho:=ifelse(sales_fiscal_year=="2010 Sales Volume" & sales_volume>0,
                                 sum_fao/(sales_volume),NaN)] 
small_projects_fao[,rescaled_rho:=rescale(rho)]

# get empirical distribution of rho, defined by alpha
small_projects_fao=small_projects_fao[order(rho)]
denom=nrow(subset(small_projects_fao,sales_fiscal_year=="2010 Sales Volume" & sales_volume>0))

small_projects_fao[,rank_firm:=ifelse(sales_fiscal_year=="2010 Sales Volume" & sales_volume>0,
                                  seq.int(nrow(small_projects_fao))/denom,NaN)]

small_projects_fao=small_projects_fao[,c('recipient_duns','rank_firm','rescaled_rho','rho')]

reg_df=merge(reg_df,small_projects_fao,by='recipient_duns',all=T)
```

## Portfolio Effects: Discrete

* See [Jie’s notes](https://github.com/QuickPay-Operational-Performance/Data-and-code/blob/master/notes/Portfolio%20model%2B0308.pdf) for details.
* Assumption: Parallel trends between small projects of firms in different terciles wtih pooled sample large projects. May not hold. Need to include firm specific control or at least plot the trends. 
* Let $Rank_f^{(k)}$ be an indicator for firm being in the k-th tercile of $Rank$. Define:
  * $Medium_i = Treat_i * Rank_f^{(2)}$
  * $High_i = Treat_i * Rank_f^{(3)}$

$$\begin{aligned} Delay_{it} &=& \beta_0+\beta_1 Treat_i + \beta_2 Medium_i+\beta_3 High_i +\beta_4 Post_t\\ && +\beta_5( Treat_i\times Post_t) + \beta_6(Medium_i\times Post_t) + \beta_7(High_i\times Post_t) + \epsilon_{it} \end{aligned}$$

```{r portfolio_regs_discrete, echo=FALSE, results='asis'}

reg_df[,rank_tercile:=ntile(rank_firm,3)]

# This will also set all NA rank_terciles to zero
reg_df[,medium_i:=ifelse(rank_tercile==2 & treat_i==1,1,0)]
reg_df[,high_i:=ifelse(rank_tercile==3 & treat_i==1,1,0)]

# set values to NA for those observations whose firm's rank is not defined
reg_df[,medium_i:=ifelse(is.na(rank_tercile),NaN,medium_i)]
reg_df[,high_i:=ifelse(is.na(rank_tercile),NaN,high_i)]

baseline_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    post_t+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    medium_i+
                    high_i+
                    post_t:treat_i+
                    post_t:treat_i:medium_i+
                    post_t:treat_i:high_i+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter+recipient_duns| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

vars.order=c('treat_i',
             'medium_i',
             'high_i',
             'post_t',
             'treat_i:post_t',
             'treat_i:medium_i:post_t',
             'treat_i:high_i:post_t')

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Discrete Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Medium_i$",
                               "$High_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$Treat_i \\times Post_t \\times Medium_i$",
                               "$Treat_i \\times Post_t \\times High_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

## Portfolio Effects: Continuous

* See [Jie’s notes](https://github.com/QuickPay-Operational-Performance/Data-and-code/blob/master/notes/Portfolio%20model%2B0308.pdf) for details.
* Define $\theta_i = Treat_i*Rank_f$

$$ \begin{aligned} Delay_{it} &=& \beta_0+\beta_1 Treat_i + \beta_2 \theta_i+\beta_3 \theta_i^2+\beta_4 Post_t\\&& + \beta_5 (Treat_i\times Post_t) + \beta_6 (\theta_i\times Post_t) +\beta_7 (\theta_i^2\times Post_t)+\epsilon_{it} \end{aligned} $$

```{r portfolio_regs_continuous, echo=FALSE, results='asis'}

reg_df[,theta_i:=rank_firm*treat_i]

baseline_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    post_t+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~treat_i+
                    theta_i+
                    I(theta_i^2)+
                    post_t:treat_i+
                    post_t:theta_i+
                    post_t:I(theta_i^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter+recipient_duns| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Continuous Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$\\theta_i$",
                               "$\\theta_i^2$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$\\theta_i \\times Post_t$",
                               "$\\theta_i^2 \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Firm's rank order : Alternate model

## Continuous model

* We have $\theta_{if} = Treat_i * Rank_f$

$$ Delay_{ift} = \beta_0 + \beta_1 \theta_{if} + \beta_2 (\theta_{if} \times Post_t) + \beta_3 Post_t + \beta_4 Rank_f + \epsilon_{ift} $$

* Consider a firm with $Rank_f = k$. Then, we have
   * Large + Before = $\beta_0 + \beta_4 k$
   * Large + After = $\beta_0+\beta_3 +\beta_4 k$
   * Small + Before = $\beta_0+\beta_1 k + \beta_4 k$
   * Small + After = $\beta_0+\beta_1 k + \beta_2 k + \beta_3 + \beta_4 k$
   * Treatment effect: $\beta_2 k$

**Interpretation:** 

* Treatment effect is $\beta_2 k$ for a firm that received a proportion $k$ of its revenue from small projects. 
* In other words, for a firm earning $k$ proportion of revenue from small projects, Quickpay increased delays on small projects by $\beta_3 k$ days.

**Assumption:** Parallel trends between large and small projects of the same firm.

<!-- ![](/Users/vibhutidhingra/Desktop/cts_te.png){width=10%,height=10%} -->

```{r continuous_treatment_regs, echo= FALSE, results='asis'}

reg_df[, theta_if := treat_i*rank_firm]

baseline_reg=felm(winsorized_delay~ theta_if+
                    post_t:theta_if+
                    rank_firm+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~theta_if+
                    post_t:theta_if+
                    rank_firm+
                    post_t+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~theta_if+
                    post_t:theta_if+
                    rank_firm+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~theta_if+
                    post_t:theta_if+
                    rank_firm+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~theta_if+
                    post_t:theta_if+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter+recipient_duns| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Continuous Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$\\theta_{if}$",
                               "$Rank_f$",
                               "$Post_t$",
                               "$\\theta_{if} \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```          

## Continuous Quadratic Model

* We have $\theta_{if} = Treat_i * Rank_f$

$$ Delay_{ift} = \beta_0 + \beta_1 \theta_{if} + \beta_2 \theta_{if}^2 + \beta_3 (\theta_{if} \times Post_t) + \beta_4 (\theta_{if}^2 \times Post_t)+ \beta_5 Post_t + \beta_6 Rank_f + \epsilon_{ift} $$

* Consider a firm with $Rank_f = k$. Then, we have
   * Large + Before = $\beta_0 + \beta_6 k$
   * Large + After = $\beta_0+\beta_5 +\beta_6 k$
   * Small + Before = $\beta_0+\beta_1 k + \beta_2 k^2 + \beta_6 k$
   * Small + After = $\beta_0+\beta_1 k + \beta_2 k^2 + \beta_3 k + \beta_4 k^2 + \beta_5 + \beta_6 k$
   * Treatment effect: $\beta_3 k + \beta_4 k^2$

**Interpretation:** 
* One unit increase in rank $k$ increases treatment effect by $\beta_3 + 2k \beta_4$.

**Assumption:** Parallel trends between large and small projects of the same firm.

```{r quadratic_cts_treatment_regs, echo= FALSE, results='asis'}

baseline_reg=felm(winsorized_delay~ theta_if+
                    I(theta_if^2)+
                    post_t:theta_if+
                    post_t:I(theta_if^2)+
                    rank_firm+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~theta_if+
                    I(theta_if^2)+
                    post_t:theta_if+
                    post_t:I(theta_if^2)+
                    rank_firm+
                    post_t+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~theta_if+
                    I(theta_if^2)+
                    post_t:theta_if+
                    post_t:I(theta_if^2)+
                    rank_firm+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~theta_if+
                    I(theta_if^2)+
                    post_t:theta_if+
                    post_t:I(theta_if^2)+
                    rank_firm+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~theta_if+
                    I(theta_if^2)+
                    post_t:theta_if+
                    post_t:I(theta_if^2)+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter+recipient_duns| # no fixed effects
                    0| # no IV
                  contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Continuous Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$\\theta_{if}$",
                               "$\\theta_{if}^2$",
                               "$Rank_f$",
                               "$Post_t$",
                               "$\\theta_{if} \\times Post_t$",
                               "$\\theta_{if}^2 \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```  

## Discrete Model

* Let $Rank_f^{(k)}$ be an indicator for firm being in the k-th tercile of $Rank$. Define:
  * $Medium_{if}=Treat_i*Rank_f^{(2)}$ and
  * $High_{if} = Treat_i*Rank_f^{(3)}$ 

$$\begin{aligned} Delay_{ift} &= \beta_0+\beta_1 Low_{if}+\beta_2 Medium_{if}+\beta_3 High_{if} +\\  & \qquad  \beta_4 Rank_f^{(2)} + \beta_5 Rank_f^{(3)}+ \beta_6 Post_t + \\& \qquad \beta_7 (Low_{if} \times Post_t) + \beta_8 (Medium_{if} \times Post_t) + \beta_9 (High_{if} \times Post_t) + \epsilon_{ift} \end{aligned}$$


* Firms in lowest tercile:
  * Large + before = $\beta_0$
  * Large + after = $\beta_0 + \beta_6$
  * Small + before = $\beta_0 + \beta_1$
  * Small + after = $\beta_0 + \beta_1 + \beta_6 + \beta_7$
  * Treatment effect = $\beta_7$

* Firms in medium tercile:
  * Large + before = $\beta_0+\beta_4$
  * Large + after = $\beta_0+\beta_4+\beta_6$
  * Small + before = $\beta_0+\beta_2+\beta_4$
  * Small + after = $\beta_0+\beta_2+\beta_4 + \beta_6 + \beta_8$
  * Treatment effect = $\beta_8$

* Firms in highest tercile:
  * Large + before = $\beta_0+\beta_5$
  * Large + after = $\beta_0 + \beta_5+\beta_6$
  * Small + before = $\beta_0+\beta_3+\beta_5$
  * Small + after = $\beta_0 + \beta_3 + \beta_5 + \beta_6 + \beta_9$
  * Treatment effect = $\beta_9$

 **Assumption:** Parallel trends between large and small projects of firms in the same tercile.
 
```{r discretize_cts_treatment, echo= FALSE, results='asis'}

# This will also set all NA rank_terciles to zero
reg_df[,low_if:=ifelse(rank_tercile==1 & treat_i==1,1,0)]
reg_df[,medium_if:=ifelse(rank_tercile==2 & treat_i==1,1,0)]
reg_df[,high_if:=ifelse(rank_tercile==3 & treat_i==1,1,0)]

# set values to NA for those observations whose firm's rank is not defined
reg_df[,low_if:=ifelse(is.na(rank_tercile),NaN,low_if)]
reg_df[,medium_if:=ifelse(is.na(rank_tercile),NaN,medium_if)]
reg_df[,high_if:=ifelse(is.na(rank_tercile),NaN,high_if)]

reg_df[,low_rank_f:=ifelse(rank_tercile==1,1,0)]
reg_df[,medium_rank_f:=ifelse(rank_tercile==2,1,0)]
reg_df[,high_rank_f:=ifelse(rank_tercile==3,1,0)]

reg_df[,low_rank_f:=ifelse(is.na(rank_tercile),NaN,low_rank_f)]
reg_df[,medium_rank_f:=ifelse(is.na(rank_tercile),NaN,medium_rank_f)]
reg_df[,high_rank_f:=ifelse(is.na(rank_tercile),NaN,high_rank_f)]


baseline_reg=felm(winsorized_delay~low_if+
                    medium_if+
                    high_if+
                    medium_rank_f+
                    high_rank_f+
                    post_t:low_if+
                    post_t:medium_if+
                    post_t:high_if+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

controls_reg=felm(winsorized_delay~low_if+
                    medium_if+
                    high_if+
                    medium_rank_f+
                    high_rank_f+
                    post_t:low_if+
                    post_t:medium_if+
                    post_t:high_if+
                    post_t+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_fe_and_controls_reg=felm(winsorized_delay~low_if+
                    medium_if+
                    high_if+
                    medium_rank_f+
                    high_rank_f+
                    post_t:low_if+
                    post_t:medium_if+
                    post_t:high_if+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    action_date_year_quarter| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

time_task_fe_and_controls_reg=felm(winsorized_delay~low_if+
                    medium_if+
                    high_if+
                    medium_rank_f+
                    high_rank_f+
                    post_t:low_if+
                    post_t:medium_if+
                    post_t:high_if+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

all_fe_and_controls_reg=felm(winsorized_delay~low_if+
                    medium_if+
                    high_if+
                    post_t:low_if+
                    post_t:medium_if+
                    post_t:high_if+
                    winsorized_initial_duration_in_days_i+
                    winsorized_initial_budget_i+
                    number_of_offers_received+
                    post_t:winsorized_initial_duration_in_days_i+
                    post_t:winsorized_initial_budget_i+
                    post_t:number_of_offers_received|
                    recipient_duns+product_or_service_code+action_date_year_quarter| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_reg,
          time_fe_and_controls_reg,
          time_task_fe_and_controls_reg,
          all_fe_and_controls_reg,
          digits=2,
          digits.extra=2,
          title = "Discrete Portfolio Effects: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          # dep.var.caption = "",
          covariate.labels = c("$Low_{if}$",
                               "$Medium_{if}$",
                               "$High_{if}$",
                               "$Rank_f^{(2)}$",
                               "$Rank_f^{(3)}$",
                               "$Post_t$",
                               "$Low_{if} \\times Post_t$",
                               "$Medium_{if} \\times Post_t$",
                               "$High_{if} \\times Post_t$",
                               "Constant"),
          object.names=FALSE,
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Year-Quarter Fixed Effects",rep("No",2),rep("Yes",3)),
                           c("Task Fixed Effects",rep("No",3),rep("Yes",2)),
                           c("Firm Fixed Effects",rep("No",4),rep("Yes",1))
                           ),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Other Proxies for Treatment intensity or Portfolio effects

## Proxy 1: Revenue from small projects

* We defined $\rho_f$ as the share of revenue a firm received from small projects in fiscal year 2010.
* The numerator of $\rho_f$ is the sum of all federal obligations from small projects of a firm in fiscal year 2010. Because obligations can be negative, the sum can be zero or negative even if the firm held substantial number of small projects.
* In the previous section, we ranked the values of $\rho_f$. But this makes interpretation somewhat tricky. The minimum rank for each firm is now 1/N and it is never zero. What does a unit increase in Rank mean?
* An alternative can be to simply scale the values of $\rho_f$ to between 0 and 1. That is, for a firm A, we define $Share_A = (\rho_A - \min(\rho_f))/(\max(\rho_f)-\min(\rho_f))$. 
  * Suppose $\rho_A= -1,\max(\rho_f)=3,\min(\rho_f)=-2$. Then, $Share_A = (-1-(-2))/(3-(-2))=1/5.$ 
  * The max share will be 1 and min share will be 0.
* Setting aside measurement issues described earlier, we have:
  * $Share_f=0$ represents a firm getting no revenue from small projects.
  * $Share_f=1$ represents a firm getting its entire revenue from small projects.

## Proxy 2: Ratio of small projects

* For firm $f$, define $Share_f = \frac{\text{Num of small projects in FY 2010}}{\text{Total num of projects in FY 2010}}$.
* Same analysis as before but advantages:
   * Sample size: only firms excluded are new entrants to government projects.
   * No measurement problem. $Share_f$ will be zero for firms with no small projects, and one for firms with only small projects.
   * We can control for differences across firms through fixed effects. This will be less of an issue here because we will have enough observations. 
   
