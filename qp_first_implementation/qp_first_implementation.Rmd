---
title: "First Implementation of QuickPay (2009-2012)"
date: " `r format(Sys.time(), '%b %d, %Y')`"
output: 
  pdf_document :
    keep_tex: true
    number_sections: true
header-includes:
 \usepackage{booktabs,longtable,dcolumn}
 \usepackage{multirow,array}
 \usepackage{wrapfig,float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r packages,warning=FALSE,message=FALSE,include=FALSE}
library(tidyverse)
library(dplyr)
library(pryr)
library(lfe) # linear fixed effects 
library(DescTools) 
library(zoo) # for year quarter
library(stargazer)
library(broom)
library(data.table)
``` 
```{r read_data, include=FALSE}
# read quarterly resampled data
df=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/resampled_qp_data/quickpay_resampled_fy10_to_fy12.csv')

# specify date columns
date_cols=c("action_date_year_quarter","last_reported_start_date","last_reported_end_date")
df[,(date_cols):= lapply(.SD, as.Date), .SDcols = date_cols]

# restrict to quarter ending June 30, 2012
df=subset(df,as.Date(action_date_year_quarter)<max(as.Date(df$action_date_year_quarter)))
# data is truncated at July 1, 2012 -- 
# so quarter ending Sept 30, 2012 will only have values as of July 1, 2012

df_first_reported=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/qp_data_first_reported.csv')
# contains time-invariant contract characteristics -- info when contract first appeared in the data
```
```{r assign_variables_1, include=FALSE}
# Assign variables: Delay, Winsorized Delay, Post_t, Treat_i ####

# sort by contract id and date 
df=df[order(contract_award_unique_key,
            action_date_year_quarter)]

# determine quarter-to-quarter delay
df[,delay:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1), 
                  last_reported_end_date-lag(last_reported_end_date,1),NaN)]

# winsorize quarter-to-quarter delay
df[,winsorized_delay:=Winsorize(delay,na.rm=TRUE)]

#Post_t: A dummy that period t is post-treatment
df[,post_t:=ifelse(action_date_year_quarter>as.Date("2011-04-27"),1,0)]
# quickpay implemented on 27 April 2011. So all quarters starting 30 June 2011 will be in post-period

#Treat_i: A dummy that contract i is in the treatment group
df[,treat_i:=ifelse(business_type=="S",1,0)]
# quickpay was implemented for small business contracts
```
```{r assign_variables_2, include=FALSE}
# Assign variables: ContractFinancing_i, Competition_i, PerformanceBased_i, Financial_Aid_i ####
df_first_reported[,contract_financing_i:=ifelse(!is.null(contract_financing_code)&
                                       !contract_financing_code%in%c("Z", ""),1,0)]
#### 
df_first_reported[,competitively_awarded_i:=ifelse(!is.null(extent_competed_code)&
                                          !extent_competed_code%in%c("","G","B", "C"),1,0)]
#### 
df_first_reported[,performance_based_contract_i:=ifelse(performance_based_service_acquisition_code=='Y',1,0)]
#### 
df_first_reported[,receives_financial_aid_i:=ifelse(receives_grants=='t'|
                                           c8a_program_participant=='t',1,0)]
#### 
df_first_reported[,receives_contracts_and_financial_aid_i:=ifelse(receives_contracts_and_grants=='t'|
                                                         receives_grants=='t'|
                                                         c8a_program_participant=='t',1,0)]

df_first_reported[,winsorized_initial_duration_in_days_i:=Winsorize(as.numeric(
                               as.Date(period_of_performance_current_end_date)-
                               as.Date(period_of_performance_start_date)),na.rm=T)]
df_first_reported[,winsorized_initial_budget_i:=Winsorize(base_and_all_options_value,na.rm=T)]

select_cols=c("contract_award_unique_key",
              "number_of_offers_received",
              "contract_financing_i",
              "competitively_awarded_i",
              "performance_based_contract_i",
              "receives_financial_aid_i",
              "receives_contracts_and_financial_aid_i",
              "winsorized_initial_duration_in_days_i",
              "winsorized_initial_budget_i")

df_first_reported_cols=df_first_reported[,..select_cols]
# not necessary but speed efficient to set keys
setkey(df_first_reported_cols,contract_award_unique_key)
setkey(df,contract_award_unique_key)
```
```{r combine_dfs, include=FALSE}
# Combine all variables into dataframe needed for regression 
reg_df=merge(df,
             df_first_reported_cols,
             all.x = TRUE, # keep values in df, add columns of df_first_reported_cols
             by=c("contract_award_unique_key"))
```

# Delays over Time

```{r plot, echo=FALSE, results='asis'}
mean_delay=df[!is.na(winsorized_delay) & action_date_year_quarter<as.Date('2012-06-30'), 
              mean(winsorized_delay),  
              by = c('action_date_year_quarter','business_type')]
mean_delay[,year_quarter:=format(action_date_year_quarter,"%Y-%b")]
mean_delay=mean_delay[order(action_date_year_quarter,business_type)]

ggplot(mean_delay, aes(x=year_quarter,
               y=V1, 
               group = business_type, 
               shape=business_type, 
               linetype=business_type))+
    geom_line() +    
    scale_x_discrete(limits=mean_delay$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average delay per quarter (in days)")+  
    annotate("text", label = "QuickPay\n implemented", x = 8, y = 50,color="dimgrey")+
    geom_vline(xintercept = 10.2, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    scale_linetype_discrete(name="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))
```

# Notation 

* Project $i$, Year-Quarter $t$
* $X_i$ denotes project level controls: initial duration, initial budget, number of offers received
* $\mu_t,\theta_{firm},\lambda_{task}$: Year-Quarter, Firm, and Product/Service code Fixed effects
* All continuous variables are winsorized at the 5\% level
$$ Treat_i = \begin{cases} 1, \text{ if project } i \text{ is a small business}\\
0, \text{ otherwise} \end{cases}$$
$$ Post_t = \begin{cases} 1, \text{ if year-quarter } t > \text{ April 27, 2011}\\
0, \text{ otherwise} \end{cases}$$

# Parallel Trends Test

Let $Time$ denote $q$-th quarter since the beginning of time horizon. For $Post_t =0$, we run the following regression:
$$ Delay_{it} = \alpha+\beta_0 Treat_i + \beta_1 (Treat_i \times Time) + \beta_2 X_i + \mu_t + \theta_{firm} + \lambda_{task} +\epsilon_{it}$$
The coefficient of interest is $\beta_1$. If this is significant, we would find evidence of a linear time trend before quickpay implementation -- violating the parallel trends assumption.
```{r parallel_trends_test, echo=FALSE, results='asis'}
df_qn<-unique(reg_df,by='action_date_year_quarter')[,"action_date_year_quarter"]
df_qn=df_qn[order(action_date_year_quarter)][,quarter_number:=seq.int(nrow(df_qn))]
reg_df=merge(reg_df,df_qn,by='action_date_year_quarter')
cluster_var = "contract_award_unique_key"

# Estimating linear time trend before quickpay was implemented
fixed_vars =  c("action_date_year_quarter",
                "recipient_duns",
                "product_or_service_code")

control_vars=c("winsorized_initial_duration_in_days_i",
               "winsorized_initial_budget_i",
               "number_of_offers_received")

pt_formula=formula(paste("winsorized_delay~treat_i+
                         quarter_number:treat_i+",
                         paste(control_vars,collapse="+"),
                         "|", paste(fixed_vars, collapse= "+"),
                         "| 0 |", cluster_var))

parallel_trend<-felm(pt_formula,
                     data=subset(reg_df,post_t==0), 
                     exactDOF = TRUE, 
                     cmethod = "reghdfe")

stargazer(parallel_trend,
          title = "Linear Time Trend Before QuickPay",
          dep.var.labels   = "$Delay_{it}$ (in days)",
          header=FALSE,
          object.names=FALSE, 
          model.numbers=FALSE,
          font.size = "small",
          digits=2,
          digits.extra=2,
          omit.stat=c("f", "ser"),
          add.lines = list(c("Fixed effects","Firm, Task, and Year-Quarter"),
                           c("Controls","Budget, Duration, Bids")), 
          covariate.labels = c("$Treat_i$", "$Treat_i \\times Time$"),
          omit = control_vars,
          table.placement = "H",
          notes=c("Each observation is a project-quarter.","SEs are robust and clustered at the project level.","Observations are for quarters before quickpay."))
```

# Baseline Regressions

$$ Delay_{it} = \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) + \epsilon_{it}$$ 

$$ \begin{aligned} Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t)\\
&+&  X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r baseline_regressions, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+post_t:treat_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          title = "Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$","$Post_t$","$Treat_i \\times Post_t$","Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          digits=2,
          digits.extra=2,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Contract Financing

$$ CF_i = \begin{cases} 1, \text{ if project } i \text{ receives contract financing}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) \\
&+&\beta_3 CF_i + \beta_4 (CF_i \times Post_t) + \beta_5 (Treat_i \times Post_t \times CF_i) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r contract_financing, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    contract_financing_i+post_t:contract_financing_i+
                    post_t:treat_i:contract_financing_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'contract_financing_i',
              'post_t:contract_financing_i',
              'treat_i:post_t:contract_financing_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Contract Financing: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CF_i$",
                               "$Post_t \\times CF_i$",
                               "$Post_t \\times CF_i \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times $  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Receives Financial Aid

$$ FinancialAid = \begin{cases} 1, \text{ if firm receives grants or is a c8A participant}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) +\beta_3 FinancialAid \\
&+& \beta_4 (FinancialAid \times Post_t) + \beta_5 (Treat_i \times Post_t \times FinancialAid) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r financial_aid, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    receives_financial_aid_i+post_t:receives_financial_aid_i+
                    post_t:treat_i:receives_financial_aid_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_financial_aid_i+
                            post_t:receives_financial_aid_i+
                            post_t:treat_i:receives_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'receives_financial_aid_i',
              'post_t:receives_financial_aid_i',
              'treat_i:post_t:receives_financial_aid_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Grants or C8A Participant: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$FinancialAid$",
                               "$Post_t \\times FinancialAid$",
                               "$Post_t \\times FinancialAid \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Receives Contracts and Financial Aid

$$ CFA = \begin{cases} 1, \text{ if firm receives "contracts and grants"}\\ 
                       \text{or grants or is a c8A participant}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
Delay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t) +\beta_3 CFA \\
&+& \beta_4 (CFA \times Post_t) + \beta_5 (Treat_i \times Post_t \times CFA) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r contracts_and_financial_aid, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(winsorized_delay~treat_i+post_t:treat_i+post_t+
                    receives_contracts_and_financial_aid_i+
                    post_t:receives_contracts_and_financial_aid_i+
                    post_t:treat_i:receives_contracts_and_financial_aid_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~treat_i+
                            post_t:treat_i+
                            receives_contracts_and_financial_aid_i+
                            post_t:receives_contracts_and_financial_aid_i+
                            post_t:treat_i:receives_contracts_and_financial_aid_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'receives_contracts_and_financial_aid_i',
              'post_t:receives_contracts_and_financial_aid_i',
              'treat_i:post_t:receives_contracts_and_financial_aid_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Contracts, Grants, or C8A Participant: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CFA$",
                               "$Post_t \\times CFA$",
                               "$Post_t \\times CFA \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Firm share of small projects

For project $i$ of firm $f$ in quarter $t$, define $\rho_f = \sum_{t\in FY2010,i\in S} \text{FAO}_{ift}/Sales_{f}^{FY2010}$. 

Define $\alpha_f = rank(\rho_f)/N$ where $rank(\rho_f)$ is the rank statistic of $\rho_{f}$ and $N = \text{number of firms}.$ For example, $rank(\rho_f)=1$ if $\rho_f=\min(\rho_1,\rho_2,\ldots,\rho_N)$.

Put simply, $\alpha_f$ is a firm's rank order based on the fraction of revenue it earned from small government projects in FY 2010.

*Hypothesis: Firms that relied more on the government experienced greater delays on their projects after QuickPay was implemented.*

$$ \begin{aligned}
Delay_{it} &=& \beta_0+\beta_1 \alpha_f + \beta_2 Post_t + \beta_3 (\alpha_f \times Post_t) + \epsilon_{it}
\end{aligned}$$

$$ \begin{aligned}
Delay_{it} &=& \beta_0+\beta_1 (\alpha_f \times Post_t) + \beta_2 X_i + \beta_3 (X_i \times Post_t) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

```{r fao, include=FALSE}
# read raw data
df_raw=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/qp_data_fy10_to_fy18.csv')

# restrict to quarters on/before June 30, 2012
df_raw[,action_date_year_quarter:=as.Date(as.yearqtr(as.Date(action_date)),frac = 1)]
df_raw_first=subset(df_raw,action_date_year_quarter<=max(df$action_date_year_quarter))

# select fao from small projects in quarters of fiscal year 2010
df_raw_first[,sb_fao_before_qp:=ifelse(contracting_officers_determination_of_business_size_code=='S' &
                          action_date_year_quarter<as.Date("2010-12-31"),
                                   federal_action_obligation,0)]

# For each firm, get total fao from small projects in quarters of fiscal year 2010
small_projects_fao=df_raw_first[,sum(sb_fao_before_qp), by= c('recipient_duns')]
setnames(small_projects_fao, "V1", "sum_fao")

# Get each firm's sales in FY 2010 from Intellect data 
intellect_data=fread('/Users/vibhutidhingra/Dropbox/data_quickpay/qp_data/govt_weight_per_recipient.csv',select=c('recipient_duns','sales_fiscal_year','sales_volume'))
intellect_data=subset(intellect_data,sales_fiscal_year=="2010 Sales Volume")

# merge the sales data with fao data
small_projects_fao=merge(small_projects_fao,
                         intellect_data,
                         by='recipient_duns',
                         all=TRUE)

# We don't have sales data for all firms in intellect and some sales are 0 
small_projects_fao[, rho:=ifelse(sales_fiscal_year=="2010 Sales Volume" & sales_volume>0,
                                 sum_fao/(sales_volume),NaN)] 

# get empirical distribution of rho, defined by alpha
small_projects_fao=small_projects_fao[order(rho)]
denom=nrow(subset(small_projects_fao,sales_fiscal_year=="2010 Sales Volume" & sales_volume>0))

small_projects_fao[,alpha_firm:=ifelse(sales_fiscal_year=="2010 Sales Volume" & sales_volume>0,
                                  seq.int(nrow(small_projects_fao))/denom,NaN)]

small_projects_fao=small_projects_fao[,c('recipient_duns','alpha_firm')]
```

```{r alpha_regs, echo=FALSE, results='asis'}

reg_df=merge(reg_df,small_projects_fao,by='recipient_duns',all=T)

# Baseline Regressions 
baseline_reg=felm(winsorized_delay~post_t:alpha_firm+
                    alpha_firm+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~post_t:alpha_firm+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~post_t:alpha_firm+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

vars.order=c('alpha_firm',
             'post_t',
             'post_t:alpha_firm')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Treatment Intensity: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$\\alpha_f$",
                               "$Post_t$",
                               "$\\alpha_f \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$    (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
         table.placement = "H",
         style="default",
        notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Terciles of Alpha

Define $\alpha_f^{(k)} =$ k-th tercile of $\alpha_f.$

```{r alpha_terciles, echo=FALSE, results='asis'}

reg_df[,alpha_tercile:=ntile(alpha_firm,3)]
reg_df[,alpha_first_tercile:=ifelse(alpha_tercile==1,1,0)]
reg_df[,alpha_second_tercile:=ifelse(alpha_tercile==2,1,0)]
reg_df[,alpha_third_tercile:=ifelse(alpha_tercile==3,1,0)]

plot_df=na.omit(reg_df)[, mean(winsorized_delay),
                        by=list(alpha_tercile,action_date_year_quarter)]

plot_df[,year_quarter:=format(action_date_year_quarter,"%Y-%b")]
plot_df=plot_df[order(action_date_year_quarter)]

ggplot(plot_df, aes(year_quarter, 
                    V1,
                    group = as.factor(alpha_tercile), 
               shape=as.factor(alpha_tercile), 
               linetype=as.factor(alpha_tercile)))+
    geom_line() +    
    scale_x_discrete(limits=plot_df$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average delay per quarter (in days)")+  
    annotate("text", label = "QuickPay\n implemented", x = 11, y = 50,color="dimgrey")+
    geom_vline(xintercept = 15, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Firm tercile",
                          breaks=c("1","2","3"),
                          labels=c("First","Second","Third"))+
    scale_linetype_discrete(name  ="Firm tercile",
                          breaks=c("1","2","3"),
                          labels=c("First","Second","Third"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))

baseline_reg=felm(winsorized_delay~post_t+
                    alpha_second_tercile+
                    alpha_third_tercile+
                    post_t:alpha_second_tercile+
                    post_t:alpha_third_tercile|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~post_t:alpha_second_tercile+
                            post_t:alpha_third_tercile+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~post_t:alpha_second_tercile+
                            post_t:alpha_third_tercile+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

vars.order=c('alpha_second_tercile',
             'alpha_third_tercile',
             'post_t',
             'post_t:alpha_second_tercile',
             'post_t:alpha_third_tercile')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Treatment Intensity: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$\\alpha_f^{(2)}$",
                               "$\\alpha_f^{(3)}$",
                               "$Post_t$",
                               "$\\alpha_f^{(2)} \\times Post_t$",
                               "$\\alpha_f^{(3)} \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$    (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
         table.placement = "H",
         style="default",
        notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```

# Treatment Intensity

Define $\theta_i = Treat_i \times \alpha_f$

```{r treat_intensity_regs, echo=FALSE, results='asis',eval = FALSE}

reg_df[,treat_intensity_i:=treat_i*alpha_firm]

# Baseline Regressions 
baseline_reg=felm(winsorized_delay~post_t:treat_intensity_i+
                    treat_intensity_i+
                    post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~post_t:treat_intensity_i+
                            treat_intensity_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~post_t:treat_intensity_i+
                                 treat_intensity_i+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

vars.order=c('treat_intensity_i',
             'post_t',
             'post_t:treat_intensity_i')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Treatment Intensity: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$\\theta_i$",
                               "$Post_t$",
                               "$\\theta_i \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$    (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
         table.placement = "H",
         style="default",
        notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)

```

```{r theta_terciles, echo=FALSE, results='asis',eval = FALSE}

reg_df[,treat_tercile:=ntile(treat_intensity_i,3)]
reg_df[,treat_first_tercile:=ifelse(treat_tercile==1,1,0)]
reg_df[,treat_second_tercile:=ifelse(treat_tercile==2,1,0)]
reg_df[,treat_third_tercile:=ifelse(treat_tercile==3,1,0)]

plot_df=na.omit(reg_df)[, mean(winsorized_delay),
                        by=list(treat_tercile,action_date_year_quarter)]

plot_df[,year_quarter:=format(action_date_year_quarter,"%Y-%b")]
plot_df=plot_df[order(action_date_year_quarter)]

ggplot(plot_df, aes(year_quarter, 
                    V1,
                    group = as.factor(treat_tercile), 
               shape=as.factor(treat_tercile), 
               linetype=as.factor(treat_tercile)))+
    geom_line() +    
    scale_x_discrete(limits=plot_df$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average delay per quarter (in days)")+  
    annotate("text", label = "QuickPay\n implemented", x = 11, y = 50,color="dimgrey")+
    geom_vline(xintercept = 15, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Treat tercile",
                          breaks=c("1","2","3"),
                          labels=c("First","Second","Third"))+
    scale_linetype_discrete(name  ="Treat tercile",
                          breaks=c("1","2","3"),
                          labels=c("First","Second","Third"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))

baseline_reg=felm(winsorized_delay~post_t+
                    treat_second_tercile+
                    treat_third_tercile+
                    post_t:treat_second_tercile+
                    post_t:treat_third_tercile|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df,
                  exactDOF = TRUE,
                  cmethod = "reghdfe")

# time fixed effects also included in the following specs
controls_and_firm_fe=felm(winsorized_delay~post_t:treat_second_tercile+
                            post_t:treat_third_tercile+
                              treat_second_tercile+
                              treat_third_tercile+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

controls_and_firm_task_fe=felm(winsorized_delay~post_t:treat_second_tercile+
                            post_t:treat_third_tercile+
                              treat_second_tercile+
                              treat_third_tercile+
                            winsorized_initial_duration_in_days_i+
                            winsorized_initial_budget_i+
                            number_of_offers_received+
                            post_t:winsorized_initial_duration_in_days_i+
                            post_t:winsorized_initial_budget_i+
                            post_t:number_of_offers_received|
                            recipient_duns+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

vars.order=c('treat_second_tercile',
             'treat_third_tercile',
             'post_t',
             'post_t:treat_second_tercile',
             'post_t:treat_third_tercile')

stargazer(baseline_reg,
          controls_and_firm_fe,
          controls_and_firm_task_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Treatment Intensity: Quickpay 2009-2011",
          dep.var.labels="$Delay_{it}$ (in days)",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$\\theta_i^{(2)}$",
                               "$\\theta_i^{(3)}$",
                               "$Post_t$",
                               "$\\theta_f^{(2)} \\times Post_t$",
                               "$\\theta_f^{(3)} \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Year-Quarter Fixed Effects","No","Yes","Yes"),
                           c("Firm Fixed Effects","No","Yes","Yes"),
                           c("Task Fixed Effects","No","No","Yes"),
                           c("Duration, Budget, Bids","No","Yes","Yes"),
                           c("$Post_t \\times$    (Duration, Budget, Bids)","No","Yes","Yes")),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:winsorized_initial_duration_in_days_i',
                   'post_t:winsorized_initial_budget_i',
                   'post_t:number_of_offers_received'),
         table.placement = "H",
         style="default",
        notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```