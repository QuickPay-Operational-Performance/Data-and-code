---
title: "Percentage Delay Rate (Non-Zero Sample): QuickPay (2009-2012)"
date: " `r format(Sys.time(), '%b %d, %Y')`"
output: 
  pdf_document:
    keep_tex: true
    number_sections: true
header-includes:
 \usepackage{booktabs,longtable,dcolumn}
 \usepackage{multirow,array}
 \usepackage{wrapfig,float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages,warning=FALSE,message=FALSE,include=FALSE}
library(openxlsx)
library(tidyverse)
library(dplyr)
library(pryr)
library(lfe) # linear fixed effects 
library(DescTools) 
library(zoo) # for year quarter
library(stargazer)
library(broom)
library(data.table)
library(scales)
```

```{r set_path_for_exporting, include=FALSE}
tables_folder='~/Desktop/Research/QuickPay/paper/Tables/non_zero_delays'
figures_folder='~/Desktop/Research/QuickPay/paper/Figures'
data_folder='~/Dropbox/data_quickpay/qp_data/'
```


```{r read_data, include=FALSE}
# Keep only projects whose start dates match with API one
projects_to_keep=fread(paste0(data_folder,'projects_to_keep.csv'))

# read quarterly resampled data
df=fread(paste0(data_folder,'resampled_qp_data/qp_resampled_data_fy10_to_fy12_with_zero_obs.csv'))
# specify date columns
date_cols=c("action_date_year_quarter","last_reported_start_date","last_reported_end_date")
df[,(date_cols):= lapply(.SD, as.Date), .SDcols = date_cols]

# restrict to quarter ending June 30, 2012
df=subset(df,as.Date(action_date_year_quarter)<as.Date('2012-07-01')&
          contract_award_unique_key%in%projects_to_keep$contract_award_unique_key)

# data is truncated at July 1, 2012 -- 
# so quarter ending Sept 30, 2012 will only have values as of July 1, 2012

df_first_reported=fread(paste0(data_folder,'qp_data_first_reported.csv'))
# contains time-invariant contract characteristics -- info when contract first appeared in the data

```

```{r assign_variables_1, include=FALSE}
# Assign variables: Delay, Winsorized Delay, Post_t, Treat_i

# some projects have action dates beyond project end date 
# some could indicate projects that ended in the beginning of a quarter -- so taking 90 days difference
# dropping these -- likely admin/documentation changes

df[,diff_end_date_and_action_date:=as.numeric(last_reported_end_date-action_date_year_quarter)]
# to ensure project ended sometime this quarter
df=subset(df,diff_end_date_and_action_date>-90)


# AD: 2015-06-30; End Date: 2015-03-31

# sort by contract id and date 
df=df[order(contract_award_unique_key,
            action_date_year_quarter)]

# determine quarter-to-quarter delay
df[,delay:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1), 
                  last_reported_end_date-lag(last_reported_end_date,1),NaN)]

# winsorize quarter-to-quarter delay
df[,winsorized_delay:=Winsorize(delay,
                                probs=c(0.05,0.95),
                                na.rm=TRUE)]

#Post_t: A dummy that period t is post-treatment
df[,post_t:=ifelse(action_date_year_quarter>as.Date("2011-04-27"),1,0)]
# quickpay implemented on 27 April 2011. So all quarters starting 30 June 2011 will be in post-period

#Treat_i: A dummy that contract i is in the treatment group
df[,treat_i:=ifelse(business_type=="S",1,0)]
# quickpay was implemented for small business contracts

```

```{r assign_variables_2, include=FALSE}

# ContractFinancing_i
df_first_reported[,contract_financing_i:=ifelse(!is.null(contract_financing_code)&
                                       !contract_financing_code%in%c("Z", ""),1,0)]
# Receives financial assistance
df_first_reported[,receives_financial_assistance:=ifelse(receives_grants=="t",1,0)]

# Competition_i
df_first_reported[,competitively_awarded_i:=ifelse(!extent_competed_code%in%c("G","B", "C"),1,0)]

df_first_reported[,initial_end_date:=period_of_performance_current_end_date]
df_first_reported[,initial_start_date:=period_of_performance_start_date]

# InitialDuration_i
df_first_reported[,initial_duration_in_days_i:=
                    as.numeric(
                    as.Date(initial_end_date)-
                    as.Date(initial_start_date))]

select_cols=c("contract_award_unique_key",
              "naics_code",
              "product_or_service_code",
              "number_of_offers_received",
              "contract_financing_i",
              "receives_financial_assistance",
              "competitively_awarded_i",
              "recipient_duns",
              "initial_end_date",
              "initial_start_date",
              "initial_duration_in_days_i",
              "base_and_all_options_value",
              "awarding_sub_agency_code")

# not necessary but speed efficient to set keys
setkey(df_first_reported[,..select_cols],
       contract_award_unique_key)
setkey(df,contract_award_unique_key)
```

```{r combine_dfs, include=FALSE}
# Combine all variables into dataframe needed for regression 
reg_df=merge(df,
             df_first_reported[,..select_cols],
             all.x = TRUE, # keep values in df, add columns of df_first_reported_cols
             by=c("contract_award_unique_key"))

reg_df[,initial_start_date:=as.Date(initial_start_date)]
reg_df[,initial_end_date:=as.Date(initial_end_date)]
reg_df[,action_date_year_quarter:=as.Date(action_date_year_quarter)]
```

```{r percentage_delay,include=FALSE}
# sort by contract id and date (just to be doubly sure)
reg_df=reg_df[order(contract_award_unique_key,
            action_date_year_quarter)]

reg_df[,last_reported_duration:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1),
                                      as.numeric(lag(last_reported_end_date,1)-initial_start_date),
                                      initial_duration_in_days_i)]

# "period_of_performance_start_date" here comes from first reported info
# So it is the actual start date for a project
# get project duration as of last quarter in the denominator
reg_df[,percentage_delay:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1),
         delay/last_reported_duration,
         NaN)]

reg_df[,wins_percentage_delay:=Winsorize(100*percentage_delay,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]

# time spent in the project so far/total time of the project
# if project was active in previous quarter
reg_df[,project_quarter_stage:=ifelse(contract_award_unique_key==lag(contract_award_unique_key,1),as.numeric(lag(action_date_year_quarter,1)-initial_start_date)/as.numeric(lag(last_reported_end_date,1)-initial_start_date),NaN)]

```

```{r positive_delays,include=FALSE}

reg_df_positive=subset(reg_df,percentage_delay>0 & !is.infinite(percentage_delay))
reg_df_positive[,winsorized_delay:=Winsorize(delay,na.rm=T)]
reg_df_positive[,wins_percentage_delay:=Winsorize(100*percentage_delay,na.rm=T)]
reg_df_positive[,winsorized_initial_duration_in_days_i:=
                    Winsorize(initial_duration_in_days_i,
                    probs=c(0.05,0.95),
                    na.rm=T)]
reg_df_positive[,winsorized_initial_budget_i:=
                    Winsorize(base_and_all_options_value,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]
reg_df_positive[,wins_project_quarter_stage:=Winsorize(project_quarter_stage,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]
```

```{r negative_delays,include=FALSE}

reg_df_negative=subset(reg_df,percentage_delay<0 & !is.infinite(percentage_delay))
reg_df_negative[,winsorized_delay:=Winsorize(delay,na.rm=T)]
reg_df_negative[,wins_percentage_delay:=Winsorize(100*percentage_delay,na.rm=T)]
reg_df_negative[,winsorized_initial_duration_in_days_i:=
                    Winsorize(initial_duration_in_days_i,
                    probs=c(0.05,0.95),
                    na.rm=T)]
reg_df_negative[,winsorized_initial_budget_i:=
                    Winsorize(base_and_all_options_value,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]
reg_df_negative[,wins_project_quarter_stage:=Winsorize(project_quarter_stage,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]

```

```{r non_zero_delays,include=FALSE}
reg_df_non_zero=subset(reg_df,percentage_delay!=0 & !is.infinite(percentage_delay))
reg_df_non_zero[,winsorized_delay:=Winsorize(delay,na.rm=T)]
reg_df_non_zero[,wins_percentage_delay:=Winsorize(100*percentage_delay,na.rm=T)]
reg_df_non_zero[,winsorized_initial_duration_in_days_i:=
                    Winsorize(initial_duration_in_days_i,
                    probs=c(0.05,0.95),
                    na.rm=T)]
reg_df_non_zero[,winsorized_initial_budget_i:=
                    Winsorize(base_and_all_options_value,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]
reg_df_non_zero[,wins_project_quarter_stage:=Winsorize(project_quarter_stage,                    
                              probs=c(0.05,0.95),
                              na.rm=T)]
```
# Percentage delays over time

* Sample restricted to projects for which start dates matches the one in API
   * This is done by using first reported "action_date" and "date_signed" 
* $PercentDelay_{it}=100 \times Delay_{it}/Duration_{i,t-1}$
    * $Duration_{i,t-1} = Deadline_{i,t-1} - StartDate_i$


```{r plot_pc_delay, echo=FALSE, results='asis'}
mean_delay=reg_df_non_zero[!is.na(wins_percentage_delay) 
                  & action_date_year_quarter<=as.Date('2012-06-30'), 
              mean(wins_percentage_delay),  
              by = c('action_date_year_quarter','business_type')]
mean_delay[,year_quarter:=format(action_date_year_quarter,"%Y-%b")]
mean_delay=mean_delay[order(action_date_year_quarter,business_type)]

ggplot(mean_delay, aes(x=year_quarter,
               y=V1, 
               group = business_type, 
               shape=business_type, 
               linetype=business_type))+
    geom_line() +    
    scale_x_discrete(limits=mean_delay$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average percentage delay rate per quarter")+  
    annotate("text", label = "QuickPay\n implemented", x = 7, y = 90,color="dimgrey")+
    geom_vline(xintercept = 10.2, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    scale_linetype_discrete(name="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))
```

## Normalized delay rate (in percentage)

```{r normalized_plot,echo=FALSE, results='asis'}
large_baseline=subset(mean_delay,year_quarter=='2010-Mar' & business_type=="O")$V1
small_baseline=subset(mean_delay,year_quarter=='2010-Mar' & business_type=="S")$V1
mean_delay[,V2:=ifelse(business_type=="S",V1*100/small_baseline,V1*100/large_baseline)]

ggplot(mean_delay, aes(x=year_quarter,
               y=V2, 
               group = business_type, 
               shape=business_type, 
               linetype=business_type))+
    geom_line() +    
    scale_x_discrete(limits=mean_delay$year_quarter)+
    geom_point(size=3)+
    labs(x="Year-Quarter", y = "Average percentage delay rate per quarter \n (normalized by delay in 2010-Mar) ")+  
    annotate("text", label = "QuickPay\n implemented", x = 7, y = 100,color="dimgrey")+
    geom_vline(xintercept = 10.2, linetype="solid", 
                color = "gray", size=1.5)+
    scale_shape_discrete(name  ="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    scale_linetype_discrete(name="Business Size",
                          breaks=c("O", "S"),
                          labels=c("Large", "Small"))+
    theme(axis.text.x = element_text(angle = 90),
    axis.line = element_line(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    legend.text = element_text(size=12))
```

```{r stargazer_format, include=FALSE}
# Code to extract only the inner part (nested within tabular) of table from stargazer
# We will use this along with threeparttable in latex later 
# Code adapted from Patrick Baylis's blog on the topic:
# https://www.patrickbaylis.com/blog/2019-11-25-r-reg-tables/
make_tex_pieces <- function(stargazer_output) {
  # Split up into header, footer, and inner
  idx0 <- grep("begin{tabular}", stargazer_output, fixed = T) # Start of \begin{tabular}
  idx1 <- grep("end{tabular}", stargazer_output, fixed = T) # End of \begin{tabular}
  idx2<-grep("Adjusted",stargazer_output,fixed=T)
  
  tex_header <- c(stargazer_output[idx0],"\\toprule")
  tex_footer <- c("\\bottomrule", stargazer_output[idx1])
  tex_inner<-c(stargazer_output[(idx0+3):idx2])
  
  # Remove [-1.8ex] and replace \hline with \midrule
  tex_inner <- gsub("\\\\[-[\\.0-9]+ex]", "", tex_inner)
  
  tex_inner <- gsub("\\hline ", "\\midrule", tex_inner)
  # Return these as a 3 element list so that the user can insert header rows (column labels)
  # and footer rows (summary statistics, fixed effects)
  # list(header = tex_header, inner = tex_inner, footer = tex_footer)
  c(tex_header,tex_inner,tex_footer)
}
```

# Baseline Regressions

$$ PercentDelay_{it} = \beta_0 + \beta_1 Treat_i + \beta_2 Post_t + \beta_3 (Treat_i \times Post_t) + e_{it}$$ 

$$ \begin{aligned} PercentDelay_{it} &=& \alpha+\beta_0 Treat_i + \beta_1 Post_t + \beta_2 (Treat_i \times Post_t)\\
&+&  X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$

## Non-zero Delays

```{r baseline_regressions, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(wins_percentage_delay~treat_i+
                     post_t:treat_i+
                     post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df_non_zero, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                           post_t:treat_i+
                           post_t+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                             post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                              post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                            post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            naics_code+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
base_table<-stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          title = "Effect of QuickPay on project delay rates",
          dep.var.labels="$PercentDelay_{it}$",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$","$Post_t$","$Treat_i \\times Post_t$","Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          digits=2,
          digits.extra=2,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Project stage","No",rep("Yes",4)),
                           c("Year-Quarter fixed effects",rep("No",2),rep("Yes",3)),
                           c("Task fixed effects",rep("No",3),rep("Yes",2)),
                           c("Industry fixed effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                   'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)

base_table_tex=make_tex_pieces(base_table)
# Write to file
write(base_table_tex,
      paste0(tables_folder,"/base_table_non_zero.tex"))

```

## Positive Delays

```{r baseline_regressions_positive, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(wins_percentage_delay~treat_i+
                     post_t:treat_i+
                     post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df_positive, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                           post_t:treat_i+
                           post_t+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df_positive, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                             post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_positive, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                              post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_positive, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                            post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            naics_code+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_positive, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
base_table<-stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          title = "Effect of QuickPay on project delay rates",
          dep.var.labels="$PercentDelay_{it}$",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$","$Post_t$","$Treat_i \\times Post_t$","Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          digits=2,
          digits.extra=2,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Project stage","No",rep("Yes",4)),
                           c("Year-Quarter fixed effects",rep("No",2),rep("Yes",3)),
                           c("Task fixed effects",rep("No",3),rep("Yes",2)),
                           c("Industry fixed effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                   'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)

base_table_tex=make_tex_pieces(base_table)
# Write to file
write(base_table_tex,
      paste0(tables_folder,"/base_table_positive.tex"))

```

## Negative Delays

```{r baseline_regressions_negative, echo=FALSE, results='asis'}
# Baseline Regressions 
baseline_reg=felm(wins_percentage_delay~treat_i+
                     post_t:treat_i+
                     post_t|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df_negative, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                           post_t:treat_i+
                           post_t+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df_negative, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                             post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_negative, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                              post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_negative, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                            post_t:treat_i+
                           log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            naics_code+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_negative, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
base_table<-stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          title = "Effect of QuickPay on project delay rates",
          dep.var.labels="$PercentDelay_{it}$",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$","$Post_t$","$Treat_i \\times Post_t$","Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          digits=2,
          digits.extra=2,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(c("Duration, Budget, Bids","No",rep("Yes",4)),
                           c("$Post_t \\times$  (Duration, Budget, Bids)","No",rep("Yes",4)),
                           c("Project stage","No",rep("Yes",4)),
                           c("Year-Quarter fixed effects",rep("No",2),rep("Yes",3)),
                           c("Task fixed effects",rep("No",3),rep("Yes",2)),
                           c("Industry fixed effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                   'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)

base_table_tex=make_tex_pieces(base_table)
# Write to file
write(base_table_tex,
      paste0(tables_folder,"/base_table_negative.tex"))

```

# Contract Financing

$$ CF_i = \begin{cases} 1, \text{ if project } i \text{ receives contract financing}\\
0, \text{ otherwise} \end{cases}$$

$$ \begin{aligned}
PercentDelay_{it} &=& \beta_0+\beta_1 Treat_i + \beta_2 Post_t + \beta_3 (Treat_i \times Post_t) \\
&+&\beta_4 CF_i + \beta_5 (CF_i \times Post_t) + \beta_6 (Treat_i \times Post_t \times CF_i) \\ 
&+&X_i + (Post_t \times X_i) + \mu_t + \theta_{firm} + \lambda_{task}+ \epsilon_{it}
\end{aligned}$$


```{r contract_financing, eval=FALSE, echo=FALSE}
# Baseline Regressions 
baseline_reg=felm(wins_percentage_delay~treat_i+
                            post_t+
                            treat_i:contract_financing_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i|
                    0| # no fixed effects
                    0| # no IV
                    contract_award_unique_key, # clustered at project level
                  data=reg_df_non_zero, 
                  exactDOF = TRUE, 
                  cmethod = "reghdfe")

controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                            post_t+
                            treat_i:contract_financing_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            0|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                            treat_i:contract_financing_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
# time fixed effects also included in the following specs
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                            treat_i:contract_financing_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                            treat_i:contract_financing_i+
                            post_t:treat_i+
                            contract_financing_i+
                            post_t:contract_financing_i+
                            post_t:treat_i:contract_financing_i+
                            log(wins_project_quarter_stage)+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            post_t:number_of_offers_received|
                            naics_code+product_or_service_code+action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=reg_df_non_zero, 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
vars.order=c('treat_i',
             'post_t',
              'treat_i:post_t',
              'contract_financing_i',
              'post_t:contract_financing_i',
             'treat_i:contract_financing_i',
              'treat_i:post_t:contract_financing_i')
contract_financing_table=stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Financial constraints and QuickPay reform",
          dep.var.labels="$PercentDelay_{it}$  ",
          dep.var.caption = "",
          order=paste0("^", vars.order , "$"),
          covariate.labels = c("$Treat_i$",
                               "$Post_t$",
                               "$Treat_i \\times Post_t$",
                               "$CF_i$",
                               "$Post_t \\times CF_i$",
                               "$Treat_i \\times CF_i$",
                               "$Post_t \\times CF_i \\times Treat_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",4)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",4)),                           c("Project age",rep("No",1),rep("Yes",4)),
                           c("Year-Quarter fixed effects",rep("No",2),rep("Yes",3)),
                           c("Task fixed effects",rep("No",3),rep("Yes",2)),
                           c("Industry fixed effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                 'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```


# Competition

## Impact on delays

Define
$$ SA_i = \begin{cases} 1, \text{ if project was signed after QuickPay}\\
0, \text{ otherwise} \end{cases}$$

$$ SB_i = \begin{cases} 1, \text{ if project was signed before QuickPay}\\
0, \text{ otherwise} \end{cases}$$

### Subsample model

For a subsample of competitive or noncompetitive projects: 

$$ \begin{aligned} PercentDelay_{it} &=& \beta_0 +\beta_1 Treat_i+ \beta_2 SA_i+ \beta_3 Post_t \\&+& \beta_4 (Treat_i \times Post_t \times SA_i )+\beta_5 (Treat_i \times Post_t \times SB_i )+e_{it} \end{aligned} $$

* According to our hypothesis, $\beta_4$ should be positive and significant for competitive projects, and insignificant for non-competitive projects. 

* In the following regressions, we also control for the project's age. Project's age is defined as the number of quarters since it first showed up in the sample. We include the terciles of project's age as a control variable. 

```{r competition_delays_subsample, echo=FALSE, results='asis'}
new_projects_after_quickpay=unique(subset(df_first_reported,action_date>as.Date('2011-04-27'))$contract_award_unique_key)
reg_df_non_zero[,project_signed_after_quickpay:=ifelse(contract_award_unique_key%in%new_projects_after_quickpay,1,0)]
reg_df_non_zero[,project_signed_before_quickpay:=ifelse(!contract_award_unique_key%in%new_projects_after_quickpay,1,0)]
baseline_reg=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                                  post_t|
                                  0| # no fixed effects
                                  0| # no IV
                                  contract_award_unique_key, # clustered at project level
                                  data=subset(reg_df_non_zero,competitively_awarded_i==1),
                                  exactDOF = TRUE,
                                  cmethod = "reghdfe")
controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                                  post_t+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            0|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            naics_code+
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==1), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
competitive_projects_table=stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of QuickPay on competitively awarded projects",
          dep.var.labels="$PercentDelay_{it}$  ",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$SA_i$",
                               "$Post_t$",
                               "$Treat_i \\times SB_i \\times Post_t$",
                               "$Treat_i \\times SA_i \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",4)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",4)),
                           c("Project age",rep("No",1),rep("Yes",4)),
                           c("Year-Quarter fixed effects",rep("No",2),rep("Yes",3)),
                           c("Task fixed effects",rep("No",3),rep("Yes",2)),
                           c("Industry fixed effects",rep("No",4),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                   'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level.",
                  "Sample restricted to fully competed projects."),
          header=F)

```

```{r non_competitive_delays_subsample, echo=FALSE, results='asis'}
baseline_reg=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                                  post_t|
                                  0| # no fixed effects
                                  0| # no IV
                                  contract_award_unique_key, # clustered at project level
                                  data=subset(reg_df_non_zero,competitively_awarded_i==0),
                                  exactDOF = TRUE,
                                  cmethod = "reghdfe")
controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                                  post_t+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            0|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==0), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==0), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==0), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                                  project_signed_after_quickpay+
                                  treat_i:post_t:project_signed_before_quickpay+
                                  treat_i:post_t:project_signed_after_quickpay+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                            naics_code+
                            product_or_service_code+
                            action_date_year_quarter|
                            0|
                            contract_award_unique_key,
                          data=subset(reg_df_non_zero,competitively_awarded_i==0), 
                          exactDOF = TRUE, 
                          cmethod = "reghdfe")

# excluding firm fixed effects here to avoid overfitting because low sample size
non_competitive_projects_table=stargazer(baseline_reg,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          digits=2,
          digits.extra=2,
          title = "Non-competitive projects and QuickPay law",
          dep.var.labels="$PercentDelay_{it}$  ",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$SA_i$",
                               "$Post_t$",
                               "$Treat_i \\times SB_i \\times Post_t$",
                               "$Treat_i \\times SA_i \\times Post_t$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-2pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",3)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",3)),
                           c("Project age",rep("No",1),rep("Yes",3)),
                           c("Year-Quarter fixed effects",rep("No",2),rep("Yes",2)),
                           c("Task fixed effects",rep("No",3),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                   'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level.",
                  "Sample restricted to non-competed projects."),
          header=F)

```

### Four-way interaction

We run the following model:

$$\begin{aligned} PercentDelay_{it} &=& \beta_0 +\beta_1 Treat_i+ \beta_2 StartedAfterQP_i+ \beta_3 Post_t+ \beta_4 Competitive_i\\ && +  \beta_5 (Treat_i \times Competitive_i) + \beta_6 (Post_t \times Competitive_i)\\ && +  \beta_7 (StartedAfterQP_i \times Competitive_i) +\beta_8 (Treat_i \times Post_t)\\ && + \beta_9 (Treat_i \times Post_t \times Competitive_i) \\ && + \beta_{10} (Treat_i \times Post_t \times StartedAfterQP_i )\\ && + \beta_{11} (Treat_i \times Post_t \times StartedAfterQP_i \times Competitive_i) + e_{it} \end{aligned}$$

**Interpretation:**

* $\beta_9$ is the difference between treatment effect for competitive and non-competitive projects signed before quickpay.
* $\beta_9 + \beta_{11}$ is the difference between treatment effect for competitive and non-competitive projects signed *after* quickpay.
* $\beta_{11}$ is our coefficient of interest because it tells us how much of the difference is there due to "aggressive bidding" after the policy.

```{r competition_delays_combined, echo= FALSE, results ='asis'}
baseline_reg=felm(wins_percentage_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                     post_t|
                                   0| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df_non_zero,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")
controls_and_no_fe_no_age=felm(wins_percentage_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                     post_t+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)|
                                   0| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df_non_zero,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")
controls_and_no_fe=felm(wins_percentage_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                     post_t+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                                   0| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df_non_zero,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")
controls_and_time_fe=felm(wins_percentage_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                                   action_date_year_quarter| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df_non_zero,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")
controls_time_task_fe=felm(wins_percentage_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                                   action_date_year_quarter+
                       product_or_service_code| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df_non_zero,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")
controls_and_all_fe=felm(wins_percentage_delay~treat_i+
                                   project_signed_after_quickpay+
                                   competitively_awarded_i+
                     treat_i:competitively_awarded_i+
                     post_t:competitively_awarded_i+
                     project_signed_after_quickpay:competitively_awarded_i+
                     treat_i:post_t+
                     treat_i:post_t:competitively_awarded_i+
                     treat_i:post_t:project_signed_after_quickpay+
                     treat_i:post_t:project_signed_after_quickpay:competitively_awarded_i+
                            log(1+winsorized_initial_duration_in_days_i)+
                            log(1+winsorized_initial_budget_i)+
                            number_of_offers_received+
                            post_t:number_of_offers_received+
                            post_t:log(1+winsorized_initial_duration_in_days_i)+
                            post_t:log(1+winsorized_initial_budget_i)+
                            log(wins_project_quarter_stage)|
                                   action_date_year_quarter+
                       product_or_service_code+naics_code| # no fixed effects
                                   0| # no IV
                                   contract_award_unique_key, # clustered at project level
                                   data=reg_df_non_zero,
                                   exactDOF = TRUE,
                                   cmethod = "reghdfe")
four_way_interaction_table=stargazer(baseline_reg,
          controls_and_no_fe_no_age,
          controls_and_no_fe,
          controls_and_time_fe,
          controls_time_task_fe,
          controls_and_all_fe,
          digits=2,
          digits.extra=2,
          title = "Effect of Competition After QuickPay: Quickpay 2009-2011",
          dep.var.labels="$PercentDelay_{it}$  ",
          dep.var.caption = "",
          covariate.labels = c("$Treat_i$",
                               "$StartedAfterQP_i$",
                               "$Competitive_i$",
                               "$Post_t$",
                               "$Treat_i \\times Competitive_i$",
                               "$Post_t \\times Competitive_i$",
                               "$StartedAfterQP_i \\times Competitive_i$",
                               "$Treat_i \\times Post_t$",
                               "$Treat_i \\times Post_t \\times Competitive_i$",
                               "$Treat_i \\times Post_t \\times StartedAfterQP_i$",
                               "$Treat_i \\times Post_t \\times StartedAfterQP_i \\times Competitive_i$",
                               "Constant"),
          object.names=FALSE, 
          model.numbers=TRUE,
          font.size = "small",
          omit.stat=c("f", "ser"),
          column.sep.width = "-3pt",
          add.lines = list(
                           c("Duration, Budget, Bids",rep("No",1),rep("Yes",5)),
                           c("$Post_t \\times $  (Duration, Budget, Bids)",rep("No",1),rep("Yes",5)),
                           c("Project age",rep("No",2),rep("Yes",4)),
                           c("Year-Quarter fixed effects",rep("No",3),rep("Yes",3)),
                           c("Task fixed effects",rep("No",4),rep("Yes",2)),
                           c("Industry fixed effects",rep("No",5),rep("Yes",1))),
          omit=c('winsorized_initial_duration_in_days_i',
                  'winsorized_initial_budget_i',
                   'number_of_offers_received',
                   'post_t:log(1+winsorized_initial_duration_in_days_i)',
                   'post_t:log(1+winsorized_initial_budget_i)',
                   'post_t:number_of_offers_received',
                   'wins_project_quarter_stage'),
          table.placement = "H",
          style="default",
          notes=c("Each observation is a project-quarter.",
                  "SEs are robust and clustered at the project level."),
          header=F)
```